<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAMplayer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #ddd;
            font-size: 1rem;
        }
        
        .file-section {
            margin-bottom: 20px;
        }
        
        .file-controls {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .file-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 12px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            text-align: center;
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-btn:hover, .file-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .player-section {
            margin-bottom: 25px;
        }
        
        .player-container {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .video-player {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: none;
        }
        
        .video-player.active {
            display: block;
        }
        
        .video-player video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .audio-player {
            width: 100%;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            display: none;
        }
        
        .audio-player.active {
            display: block;
        }
        
        .audio-player-container {
            width: 100%;
        }
        
        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .audio-progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            position: relative;
        }
        
        .audio-time {
            font-size: 0.8rem;
            color: #ddd;
            min-width: 40px;
        }
        
        .audio-progress {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        
        .audio-progress-filled {
            height: 100%;
            background: #3498db;
            width: 0%;
            transition: width 0.1s;
        }
        
        .progress-thumb {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .audio-volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .audio-volume {
            flex: 1;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }
        
        .audio-volume-filled {
            height: 100%;
            background: #2ecc71;
            width: 50%;
        }
        
        .volume-thumb {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .audio-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .audio-btn {
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .audio-btn.active {
            color: #3498db;
            transform: scale(1.1);
        }
        
        .video-subtitles {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1.2rem;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            padding: 0 15px;
            z-index: 10;
            cursor: text;
            user-select: text;
            pointer-events: none;
        }
        
        .video-subtitles span {
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            max-width: 90%;
            cursor: text;
            user-select: text;
            pointer-events: auto;
        }
        
        .video-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn:hover, .control-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .audio-info {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .album-art {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .album-art i {
            font-size: 30px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .track-info h2 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }
        
        .track-info p {
            color: #bbb;
            font-size: 0.9rem;
        }
        
        .subtitle-section {
            margin-bottom: 25px;
        }
        
        .subtitle-display {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            min-height: 100px;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            user-select: text;
        }
        
        .subtitle-text {
            transition: all 0.3s;
        }
        
        .highlight {
            background-color: rgba(52, 152, 219, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .subtitle-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .subtitle-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .subtitle-btn:hover, .subtitle-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .hint {
            text-align: center;
            color: #bbb;
            font-size: 0.9rem;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        footer {
            margin-top: 25px;
            text-align: center;
            color: #ddd;
            font-size: 0.8rem;
            padding: 0 10px;
            width: 100%;
        }
        
        .hidden {
            display: none;
        }
        
        .word {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .word:hover, .word:active {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #3498db;
            font-style: italic;
        }

        .error {
            color: #e74c3c;
            text-align: center;
        }
        
        /* Ankiéƒ¨åˆ†æ ·å¼ */
        .anki-section {
            margin-bottom: 20px;
        }
        
        .anki-container {
            background: rgba(30, 30, 40, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .anki-status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .anki-status {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 200px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-connected {
            background-color: #2ecc71;
        }
        
        .status-disconnected {
            background-color: #e74c3c;
        }
        
        .anki-controls {
            display: flex;
            gap: 8px;
        }
        
        .anki-btn {
            background: rgba(155, 89, 182, 0.7);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }
        
        .anki-btn:hover, .anki-btn:active {
            background: rgba(155, 89, 182, 1);
        }
        
        .add-to-anki-btn {
            background: rgba(231, 76, 60, 0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            margin-top: 15px;
            width: 100%;
        }
        
        .add-to-anki-btn:hover, .add-to-anki-btn:active {
            background: rgba(231, 76, 60, 1);
        }
        
        /* ä¿®å¤ï¼šé…ç½®è®¾ç½®å§‹ç»ˆå¯è§ */
        .config-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        
        .config-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        .config-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ddd;
        }
        
        .config-input {
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 0.9rem;
        }
        
        /* æ—¶é—´è·³è½¬æ  */
        .time-input-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            width: 100%;
            justify-content: center;
        }
        
        .time-input {
            flex: 1;
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            max-width: 120px;
        }
        
        .time-jump-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ä¿®å¤ï¼šåº•éƒ¨å¼¹å‡ºé¢æ¿ - ç§»é™¤å¤§æ¡†æ»šåŠ¨ */
        .dictionary-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            max-height: 80vh;
        }
        
        .dictionary-panel.active {
            transform: translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .close-panel {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }
        
        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* è‡ªåŠ¨æ£€æµ‹çš„ç‰Œç»„å’Œå­—æ®µé€‰æ‹© */
        .auto-config-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }
        
        .auto-config-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 10px;
        }
        
        .auto-config-label {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #ddd;
        }
        
        .auto-config-select {
            padding: 8px 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 0.9rem;
        }
        
        /* ä¿®å¤ï¼šè¯å…¸é¢æ¿ä¸­çš„æœç´¢æ¡† */
        .panel-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .panel-search-input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .panel-search-btn {
            background: rgba(46, 204, 113, 0.7);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panel-search-btn:hover, .panel-search-btn:active {
            background: rgba(46, 204, 113, 1);
        }
        
        /* ä¿®å¤ï¼šæ·»åŠ AnkiæŒ‰é’®ä¸æœç´¢æŒ‰é’®å¹¶æ’ - ä½¿ç”¨å›¾æ ‡ */
        .panel-search-anki-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .panel-search-container {
            display: flex;
            flex: 1;
            gap: 10px;
        }
        
        .panel-anki-btn {
            background: rgba(231, 76, 60, 0.7);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            width: 50px;
        }
        
        .panel-anki-btn:hover, .panel-anki-btn:active {
            background: rgba(231, 76, 60, 1);
        }
        
        .panel-anki-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* åŸå¥æ˜¾ç¤ºåŒºåŸŸ */
        .original-sentence {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            line-height: 1.5;
            font-size: 1rem;
        }
        
        .sentence-word {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .sentence-word:hover, .sentence-word:active {
            background-color: rgba(52, 152, 219, 0.2);
        }
        
        /* ä¿®å¤ï¼šè¯å…¸ç»“æœæ ·å¼ - å›ºå®šé«˜åº¦å¹¶åªå…è®¸é‡Šä¹‰æ æ»šåŠ¨ */
        .dictionary-result {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            min-height: 100px;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            font-size: 0.95rem;
        }
        
        .word-header {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .word-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .phonetic {
            color: #3498db;
            font-style: italic;
        }
        
        .meaning-section {
            margin-bottom: 15px;
        }
        
        .part-of-speech {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 5px;
        }
        
        .definition {
            margin-left: 15px;
            margin-bottom: 5px;
        }
        
        .example {
            margin-left: 15px;
            font-style: italic;
            color: #ddd;
            margin-bottom: 8px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .dictionary-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }
        
        .tab-button {
            background: transparent;
            color: #bbb;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
            font-size: 0.95rem;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom: 2px solid #3498db;
        }
        
        .tab-button:hover {
            color: #3498db;
        }
        
        .tab-content {
            position: relative;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* ä¿®å¤ï¼šè‡ªå®šä¹‰é‡Šä¹‰æ¡† */
        .custom-definition {
            margin-top: 15px;
        }
        
        .custom-definition textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
        }
        
        /* å­—å¹•åˆ—è¡¨æ ·å¼ */
        .subtitle-list-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 15px 15px 0 0;
            padding: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .subtitle-list-panel.active {
            transform: translateY(0);
        }
        
        .subtitle-list {
            list-style: none;
        }
        
        .subtitle-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .subtitle-item:hover, .subtitle-item:active {
            background: rgba(52, 152, 219, 0.2);
        }
        
        .subtitle-item.active {
            background: rgba(52, 152, 219, 0.4);
        }
        
        /* GitHubé“¾æ¥æ ·å¼ */
        .github-link {
            margin-top: 15px;
            text-align: center;
        }
        
        .github-link a {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: color 0.3s, transform 0.3s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .github-link a:hover {
            color: #3498db;
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .github-link svg {
            width: 24px;
            height: 24px;
        }
        
        /* å›¾æ ‡æŒ‰é’®æ ·å¼ */
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(52, 152, 219, 0.7);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .icon-btn:hover, .icon-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .icon-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* åª’ä½“ç±»å‹é€‰æ‹©å™¨ */
        .media-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .media-type-btn {
            background: rgba(52, 152, 219, 0.3);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .media-type-btn.active {
            background: rgba(52, 152, 219, 0.9);
        }
        
        /* è¯­è¨€æ¨¡å¼é€‰æ‹©å™¨ */
        .language-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .language-btn {
            background: rgba(155, 89, 182, 0.3);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .language-btn.active {
            background: rgba(155, 89, 182, 0.9);
        }
        
        /* å…¨å±æ ·å¼ */
        .video-player:-webkit-full-screen {
            width: 100%;
            height: 100%;
        }
        
        .video-player:-moz-full-screen {
            width: 100%;
            height: 100%;
        }
        
        .video-player:-ms-fullscreen {
            width: 100%;
            height: 100%;
        }
        
        .video-player:fullscreen {
            width: 100%;
            height: 100%;
        }
        
        .video-player:-webkit-full-screen .video-subtitles {
            font-size: 1.5rem;
            bottom: 50px;
        }
        
        .video-player:-moz-full-screen .video-subtitles {
            font-size: 1.5rem;
            bottom: 50px;
        }
        
        .video-player:-ms-fullscreen .video-subtitles {
            font-size: 1.5rem;
            bottom: 50px;
        }
        
        .video-player:fullscreen .video-subtitles {
            font-size: 1.5rem;
            bottom: 50px;
        }
        
        /* éŸ³é¢‘æ»šåŠ¨å­—å¹•æ ·å¼ */
        .audio-subtitles {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            display: none;
        }
        
        .audio-subtitles.active {
            display: block;
        }
        
        .audio-subtitle-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .audio-subtitle-item:hover, .audio-subtitle-item:active {
            background: rgba(52, 152, 219, 0.2);
        }
        
        .audio-subtitle-item.active {
            background: rgba(52, 152, 219, 0.4);
        }
        
        /* è¿½åŠ è¯æ±‡æŒ‰é’®æ ·å¼ */
        .append-word-btn {
            background: rgba(241, 196, 15, 0.7);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            width: 50px;
        }
        
        .append-word-btn:hover, .append-word-btn:active {
            background: rgba(241, 196, 15, 1);
        }
        
        /* é¡¶éƒ¨æŒ‰é’®å¸ƒå±€ */
        .top-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .media-mode-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }
        
        .media-mode-btn:hover, .media-mode-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        .language-mode-btn {
            background: rgba(155, 89, 182, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }
        
        .language-mode-btn:hover, .language-mode-btn:active {
            background: rgba(155, 89, 182, 1);
        }
        
        .import-controls {
            display: flex;
            gap: 8px;
            flex: 1;
            justify-content: flex-end;
        }
        
        .import-btn {
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }
        
        .import-btn:hover, .import-btn:active {
            background: rgba(52, 152, 219, 1);
        }
        
        /* ç§»åŠ¨è®¾å¤‡æ¨ªå±é€‚é… */
        @media (min-width: 768px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .file-controls {
                flex-direction: row;
            }
            
            .file-btn {
                flex: 1;
            }
            
            .word-header {
                flex-direction: row;
                align-items: center;
            }
            
            .anki-controls {
                flex-direction: row;
            }
            
            .config-row {
                flex-direction: row;
                align-items: center;
            }
            
            .config-label {
                width: 120px;
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .config-input {
                flex: 1;
            }
            
            .subtitle-controls {
                flex-direction: row;
            }
            
            .video-player {
                height: 400px;
            }
            
            .auto-config-row {
                flex-direction: row;
                align-items: center;
            }
            
            .auto-config-label {
                width: 120px;
                margin-bottom: 0;
                margin-right: 10px;
            }
            
            .auto-config-select {
                flex: 1;
            }
            
            /* PCç«¯åº•éƒ¨é¢æ¿æ ·å¼ */
            .dictionary-panel {
                left: 50%;
                right: auto;
                width: 90%;
                max-width: 600px;
                transform: translate(-50%, 100%);
                border-radius: 15px;
            }
            
            .dictionary-panel.active {
                transform: translate(-50%, 0);
                bottom: 20px;
            }
            
            .subtitle-list-panel {
                left: 50%;
                right: auto;
                width: 90%;
                max-width: 600px;
                transform: translate(-50%, 100%);
                border-radius: 15px;
            }
            
            .subtitle-list-panel.active {
                transform: translate(-50%, 0);
                bottom: 20px;
            }
            
            /* ä¿®å¤ï¼šé…ç½®è®¾ç½®PCç«¯å§‹ç»ˆå¯è§ */
            .config-section, .auto-config-section {
                background: rgba(0, 0, 0, 0.5);
            }
        }
        
        /* å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 767px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            .album-art {
                width: 70px;
                height: 70px;
                margin-right: 12px;
            }
            
            .track-info h2 {
                font-size: 1.2rem;
            }
            
            .subtitle-display {
                font-size: 1rem;
                padding: 12px;
            }
            
            .subtitle-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .file-btn {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            .anki-btn {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .video-player {
                height: 250px;
            }
            
            .video-subtitles {
                font-size: 1rem;
            }
            
            .time-input-container {
                width: 100%;
                justify-content: center;
            }
            
            .time-input {
                max-width: 100px;
            }
            
            /* ä¿®å¤ï¼šç§»åŠ¨ç«¯æœç´¢å’ŒAnkiæŒ‰é’®å¸ƒå±€ - ä¿æŒå¹¶æ’ */
            .panel-search-anki-container {
                flex-direction: row;
            }
            
            /* ä¿®å¤æœç´¢å’ŒAnkiæŒ‰é’®å¸ƒå±€ */
            .panel-search-container {
                display: flex;
                flex-wrap: nowrap;
                align-items: center;
                gap: 5px;
            }

            .panel-search-input {
                flex: 1;
                min-width: 0; /* é˜²æ­¢è¾“å…¥æ¡†æº¢å‡º */
                font-size: 14px;
                padding: 8px 10px;
            }

            .panel-search-btn, 
            .append-word-btn, 
            .panel-anki-btn {
                flex-shrink: 0;
                width: 40px;
                height: 40px;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .panel-anki-btn {
                width: 45px; /* AnkiæŒ‰é’®ç¨å¾®å®½ä¸€ç‚¹ */
            }
            
            .panel-anki-btn {
                width: 50px;
            }
            
            /* AnkiçŠ¶æ€è¡Œåœ¨ç§»åŠ¨ç«¯çš„å¸ƒå±€ */
            .anki-status-row {
                flex-direction: row;
                align-items: center;
            }
            
            .anki-status {
                min-width: auto;
            }
            
            .anki-controls {
                flex: 1;
                justify-content: flex-end;
            }
            
            /* é¡¶éƒ¨æŒ‰é’®å¸ƒå±€åœ¨ç§»åŠ¨ç«¯çš„é€‚é… */
            .top-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .import-controls {
                justify-content: space-between;
            }
        }
        
        /* è¶…å°å±å¹•æ‰‹æœºé€‚é… */
        @media (max-width: 360px) {
            .file-btn {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .anki-btn {
                padding: 8px 6px;
                font-size: 0.75rem;
            }
            
            .subtitle-btn {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .panel-search-anki-container {
                flex-direction: column;
            }
            
            .panel-anki-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>VAMplayer</h1>
        <p class="subtitle">æ”¯æŒè§†é¢‘/éŸ³é¢‘æ’­æ”¾ã€å­—å¹•æ˜¾ç¤ºä¸Ankiå¡ç‰‡ç”ŸæˆåŠŸèƒ½</p>
    </header>
    
    <div class="container">
        <section class="anki-section">
            <div class="anki-container">
                <div class="anki-status-row">
                    <div class="anki-status">
                        <div class="status-indicator" id="anki-status-indicator"></div>
                        <span id="anki-status-text">æ£€æŸ¥Ankiè¿æ¥çŠ¶æ€...</span>
                    </div>
                    <div class="anki-controls">
                        <button class="anki-btn" id="check-anki-btn">çŠ¶æ€</button>
                        <button class="anki-btn" id="show-config-btn">é…ç½®</button>
                    </div>
                </div>
                
                <!-- é¡¶éƒ¨æ§åˆ¶æŒ‰é’® -->
                <div class="top-controls">
                    <button class="media-mode-btn" id="media-mode-btn">
                        <i class="fas fa-video"></i> è§†é¢‘æ¨¡å¼
                    </button>
                    <button class="language-mode-btn" id="language-mode-btn">
                        <i class="fas fa-language"></i> è‹±è¯­æ¨¡å¼
                    </button>
                    <div class="import-controls">
                        <button class="import-btn" id="subtitle-import-btn">
                            <i class="fas fa-closed-captioning"></i> å­—å¹•
                        </button>
                        <button class="import-btn" id="media-import-btn">
                            <i class="fas fa-file-video"></i> è§†é¢‘
                        </button>
                    </div>
                </div>
                
                <input type="file" id="video-file-input" accept="video/*" class="hidden">
                <input type="file" id="audio-file-input" accept="audio/*" class="hidden">
                <input type="file" id="subtitle-file-input" accept=".srt,.vtt,.txt" class="hidden">
                
                <div class="auto-config-section hidden" id="auto-config-section">
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="deck-select">ç‰Œç»„:</label>
                        <select class="auto-config-select" id="deck-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="model-select">ç¬”è®°ç±»å‹:</label>
                        <select class="auto-config-select" id="model-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="word-field-select">å•è¯å­—æ®µ:</label>
                        <select class="auto-config-select" id="word-field-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="sentence-field-select">å¥å­å­—æ®µ:</label>
                        <select class="auto-config-select" id="sentence-field-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="definition-field-select">é‡Šä¹‰å­—æ®µ:</label>
                        <select class="auto-config-select" id="definition-field-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="audio-field-select">éŸ³é¢‘å­—æ®µ:</label>
                        <select class="auto-config-select" id="audio-field-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="auto-config-row">
                        <label class="auto-config-label" for="image-field-select">å›¾ç‰‡å­—æ®µ:</label>
                        <select class="auto-config-select" id="image-field-select">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="player-section">
            <div class="player-container">
                <div class="audio-info">
                    <div class="album-art">
                        <i id="media-icon">â–¶</i>
                    </div>
                    <div class="track-info">
                        <h2 id="track-title">è¯·é€‰æ‹©åª’ä½“æ–‡ä»¶</h2>
                        <p id="track-description">æ”¯æŒ MP4, AVI, MKV, MP3, WAV ç­‰æ ¼å¼</p>
                    </div>
                </div>
                
                <div class="video-player" id="video-player">
                    <video id="player" controls>
                        <!-- è§†é¢‘æºå°†é€šè¿‡JavaScriptåŠ¨æ€è®¾ç½® -->
                    </video>
                    <div class="video-subtitles" id="video-subtitles">
                        <!-- è§†é¢‘å†…å­—å¹•å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="audio-player" id="audio-player">
                    <div class="audio-player-container">
                        <div class="audio-controls">
                            <div class="audio-progress-container">
                                <span class="audio-time" id="audio-current-time">0:00</span>
                                <div class="audio-progress" id="audio-progress">
                                    <div class="audio-progress-filled" id="audio-progress-filled"></div>
                                    <div class="progress-thumb" id="progress-thumb"></div>
                                </div>
                                <span class="audio-time" id="audio-duration">0:00</span>
                            </div>
                            <div class="audio-volume-container">
                                <span>ğŸ”Š</span>
                                <div class="audio-volume" id="audio-volume">
                                    <div class="audio-volume-filled" id="audio-volume-filled"></div>
                                    <div class="volume-thumb" id="volume-thumb"></div>
                                </div>
                            </div>
                            <div class="audio-buttons">
                                <button class="audio-btn" id="audio-play-pause-btn">â–¶</button>
                            </div>
                        </div>
                    </div>
                    <div class="audio-subtitles" id="audio-subtitles">
                        <!-- éŸ³é¢‘æ»šåŠ¨å­—å¹•å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="video-controls">
                    <button class="control-btn" id="prev-sentence-btn" title="ä¸Šä¸€å¥">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn" id="next-sentence-btn" title="ä¸‹ä¸€å¥">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="control-btn" id="toggle-video-subtitles-btn" title="åˆ‡æ¢è§†é¢‘å†…å­—å¹•">
                        <i class="fas fa-closed-captioning"></i>
                    </button>
                    <button class="control-btn" id="show-subtitle-list-btn" title="å…¨éƒ¨å­—å¹•">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="control-btn" id="toggle-audio-subtitles-btn" title="åˆ‡æ¢éŸ³é¢‘å­—å¹•">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <div class="time-input-container">
                        <input type="number" class="time-input" id="time-jump-input" placeholder="æ—¶é—´(ç§’)" step="0.1" min="0">
                        <button class="time-jump-btn" id="time-jump-btn">è·³è½¬</button>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="subtitle-section">
            <div class="subtitle-display" id="subtitle-display">
                <div class="subtitle-text" id="subtitle-text">
                    æ— å­—å¹•
                </div>
            </div>
            <div class="subtitle-controls">
                <button class="subtitle-btn" id="toggle-subtitle-btn">æ˜¾ç¤º/éšè—å­—å¹•</button>
            </div>
            <p class="hint">æç¤ºï¼šç›´æ¥ç‚¹å‡»å­—å¹•ä¸­çš„å•è¯ï¼Œè¯¥å•è¯ä¼šè‡ªåŠ¨æŸ¥è¯¢å¹¶æ˜¾ç¤ºé‡Šä¹‰</p>
        </section>
        
        <div class="github-link">
            <a href="https://github.com/FantasyzeroXYZ/VAMplayer" target="_blank" title="æŸ¥çœ‹é¡¹ç›®æºç ">
                <i class="fab fa-github"></i>
            </a>
        </div>
    </div>
    
    <!-- åº•éƒ¨å¼¹å‡ºé¢æ¿ -->
    <div class="panel-overlay" id="panel-overlay"></div>
    <div class="dictionary-panel" id="dictionary-panel">
        <div class="panel-header">
            <div class="panel-title" id="panel-word-title">å•è¯æŸ¥è¯¢</div>
            <button class="close-panel" id="close-panel">Ã—</button>
        </div>
        
        <!-- ä¿®å¤ï¼šæœç´¢å’ŒAnkiæŒ‰é’®å¹¶æ’ - ä½¿ç”¨å›¾æ ‡ -->
        <div class="panel-search-anki-container">
            <div class="panel-search-container">
                <input type="text" class="panel-search-input" id="panel-search-input" placeholder="è¾“å…¥è¦æŸ¥è¯¢çš„å•è¯...">
                <button class="panel-search-btn" id="panel-search-btn">
                    <i class="fas fa-search"></i>
                </button>
                <button class="append-word-btn" id="append-word-btn" title="è¿½åŠ è¯æ±‡">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="panel-anki-btn" id="panel-add-to-anki-btn" title="æ·»åŠ åˆ°Anki">
                    <img src="/assets/icons8-anki-24.png" alt="Anki" class="anki-icon">
                </button>
            </div>
        </div>
        
        <div class="original-sentence" id="original-sentence">
            åŸå¥å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
        
        <!-- æ ‡ç­¾é¡µå¯¼èˆª é»˜è®¤æ ‡ç­¾é¡µactive-->  
        <div class="dictionary-tabs">
            <button class="tab-button active" data-tab="dictionary-tab">è¯å…¸é‡Šä¹‰</button>
            <button class="tab-button" data-tab="web-tab">ç½‘é¡µæŸ¥è¯¢</button>
            <button class="tab-button" data-tab="custom-tab">è‡ªå®šä¹‰é‡Šä¹‰</button>
        </div>
        
        <!-- æ ‡ç­¾é¡µå†…å®¹ é»˜è®¤æ ‡ç­¾é¡µactive-->
        <div class="tab-content">
            <div id="dictionary-tab" class="tab-pane active">
                <div class="dictionary-result" id="panel-dictionary-result">
                    æŸ¥è¯¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
                </div>
            </div>
            <div id="custom-tab" class="tab-pane">
                <div class="custom-definition">
                    <textarea id="panel-custom-definition-input" placeholder="å¦‚æœæŸ¥è¯æ²¡æœ‰è¿”å›å†…å®¹æˆ–è€…æƒ³è‡ªå®šä¹‰é‡Šä¹‰å†…å®¹ï¼Œè¯·åœ¨æ­¤è¾“å…¥..."></textarea>
                </div>
            </div>
            <div id="web-tab" class="tab-pane">
                <div class="dictionary-result" id="panel-web-result">
                    <iframe id="web-search-frame" style="width: 100%; height: 300px; border: none;" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å­—å¹•åˆ—è¡¨é¢æ¿ -->
    <div class="subtitle-list-panel" id="subtitle-list-panel">
        <div class="panel-header">
            <div class="panel-title">å…¨éƒ¨å­—å¹•</div>
            <button class="close-panel" id="close-subtitle-list-panel">Ã—</button>
        </div>
        
        <ul class="subtitle-list" id="subtitle-list">
            <!-- å­—å¹•åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
        </ul>
    </div>
    
    <footer>
        <p>ç½‘é¡µåª’ä½“æ’­æ”¾å™¨ - ä¸“ä¸ºè¯­è¨€å­¦ä¹ è®¾è®¡</p>
    </footer>

    <!-- å¼•å…¥kuromoji JSåº“ -->
    <script src="./build/kuromoji.js"></script>

    <script>
        // è·å–DOMå…ƒç´ 
        const mediaModeBtn = document.getElementById('media-mode-btn');
        const languageModeBtn = document.getElementById('language-mode-btn');
        const subtitleImportBtn = document.getElementById('subtitle-import-btn');
        const mediaImportBtn = document.getElementById('media-import-btn');
        const videoFileInput = document.getElementById('video-file-input');
        const audioFileInput = document.getElementById('audio-file-input');
        const subtitleFileInput = document.getElementById('subtitle-file-input');
        const trackTitle = document.getElementById('track-title');
        const trackDescription = document.getElementById('track-description');
        const subtitleText = document.getElementById('subtitle-text');
        const toggleSubtitleBtn = document.getElementById('toggle-subtitle-btn');
        const subtitleDisplay = document.getElementById('subtitle-display');
        const videoPlayer = document.getElementById('player');
        const videoSubtitles = document.getElementById('video-subtitles');
        const mediaIcon = document.getElementById('media-icon');
        
        // åª’ä½“ç±»å‹é€‰æ‹©
        const videoPlayerContainer = document.getElementById('video-player');
        const audioPlayerContainer = document.getElementById('audio-player');
        
        // éŸ³é¢‘æ’­æ”¾å™¨æ§ä»¶
        const audioCurrentTime = document.getElementById('audio-current-time');
        const audioDuration = document.getElementById('audio-duration');
        const audioProgress = document.getElementById('audio-progress');
        const audioProgressFilled = document.getElementById('audio-progress-filled');
        const progressThumb = document.getElementById('progress-thumb');
        const audioVolume = document.getElementById('audio-volume');
        const audioVolumeFilled = document.getElementById('audio-volume-filled');
        const volumeThumb = document.getElementById('volume-thumb');
        const audioPlayPauseBtn = document.getElementById('audio-play-pause-btn');
        const audioSubtitles = document.getElementById('audio-subtitles');
        const toggleAudioSubtitlesBtn = document.getElementById('toggle-audio-subtitles-btn');
        
        // Ankiç›¸å…³å…ƒç´ 
        const ankiStatusIndicator = document.getElementById('anki-status-indicator');
        const ankiStatusText = document.getElementById('anki-status-text');
        const checkAnkiBtn = document.getElementById('check-anki-btn');
        const showConfigBtn = document.getElementById('show-config-btn');
        const autoConfigSection = document.getElementById('auto-config-section');
        const addToAnkiBtn = document.getElementById('panel-add-to-anki-btn');
        const customDefinitionInput = document.getElementById('panel-custom-definition-input');
        
        // å­—å¹•è·³è½¬ç›¸å…³å…ƒç´ 
        const prevSentenceBtn = document.getElementById('prev-sentence-btn');
        const nextSentenceBtn = document.getElementById('next-sentence-btn');
        const timeJumpInput = document.getElementById('time-jump-input');
        const timeJumpBtn = document.getElementById('time-jump-btn');
        const subtitleList = document.getElementById('subtitle-list');
        const showSubtitleListBtn = document.getElementById('show-subtitle-list-btn');
        const subtitleListPanel = document.getElementById('subtitle-list-panel');
        const closeSubtitleListPanel = document.getElementById('close-subtitle-list-panel');
        const toggleVideoSubtitlesBtn = document.getElementById('toggle-video-subtitles-btn');
        
        // è‡ªåŠ¨é…ç½®ç›¸å…³å…ƒç´ 
        const deckSelect = document.getElementById('deck-select');
        const modelSelect = document.getElementById('model-select');
        const wordFieldSelect = document.getElementById('word-field-select');
        const sentenceFieldSelect = document.getElementById('sentence-field-select');
        const definitionFieldSelect = document.getElementById('definition-field-select');
        const audioFieldSelect = document.getElementById('audio-field-select');
        const imageFieldSelect = document.getElementById('image-field-select');
        
        // åº•éƒ¨é¢æ¿ç›¸å…³å…ƒç´ 
        const dictionaryPanel = document.getElementById('dictionary-panel');
        const panelOverlay = document.getElementById('panel-overlay');
        const closePanelBtn = document.getElementById('close-panel');
        const panelDictionaryResult = document.getElementById('panel-dictionary-result');
        const panelWordTitle = document.getElementById('panel-word-title');
        const panelSearchInput = document.getElementById('panel-search-input');
        const panelSearchBtn = document.getElementById('panel-search-btn');
        const originalSentence = document.getElementById('original-sentence');
        const appendWordBtn = document.getElementById('append-word-btn');
        const webSearchFrame = document.getElementById('web-search-frame');
        
        // æ–°å¢å…ƒç´ 
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanes = document.querySelectorAll('.tab-pane');
        
        // çŠ¶æ€å˜é‡
        let subtitles = [];
        let subtitleVisible = true;
        let videoSubtitlesVisible = true;
        let audioSubtitlesVisible = false;
        let currentHighlightedWord = null;
        let currentWord = '';
        let currentSentence = '';
        let currentSubtitleIndex = 0; // å½“å‰å­—å¹•ç´¢å¼•
        let currentMediaFile = null;
        let currentMediaType = 'video'; // 'video' æˆ– 'audio'
        let currentLanguageMode = 'english'; // 'english' æˆ– 'japanese'
        let playerWasPlaying = false;
        let ankiConnected = false;
        let ankiDecks = [];
        let ankiModels = [];
        let currentModelFields = [];
        let activeTab = 'dictionary-tab'; // å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µï¼Œé»˜è®¤æ ‡ç­¾é¡µ
        let isProcessingAnki = false; // é˜²æ­¢é‡å¤ç‚¹å‡»
        let audioContext = null;
        let audioBuffer = null;
        let audioElement = null;
        let isDraggingProgress = false;
        let isDraggingVolume = false;
        let japaneseWords = []; // å­˜å‚¨æ—¥è¯­åˆ†è¯ç»“æœ
        let tokenizer = null; // ç”¨æ¥å­˜åˆ†è¯å™¨å®ä¾‹
        let currentWordIndex = -1; // å½“å‰é€‰æ‹©è¯æ±‡çš„ç´¢å¼•
        let appendedWords = []; // å·²è¿½åŠ è¯æ•°ç»„
        
        

        // åˆå§‹åŒ–å‡½æ•°
        async function initKuromoji() {
            return new Promise((resolve, reject) => {
                if (!window.kuromoji) { // åº“æ˜¯å¦åŠ è½½
                    reject(new Error("kuromoji.js æœªåŠ è½½"));
                    return;
                }
                window.kuromoji.builder({ dicPath: "./dict/" }).build(function(err, tk) {
                    if (err) { reject(err); return; }
                    tokenizer = tk; // ä¿å­˜å®ä¾‹
                    console.log("kuromoji åˆå§‹åŒ–æˆåŠŸ âœ…");
                    resolve(tk);
                });
            });
        }

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // å­˜å‚¨é…ç½®åˆ°localStorage
        function saveConfig() {
            const config = {
                deck: deckSelect.value,
                model: modelSelect.value,
                wordField: wordFieldSelect.value,
                sentenceField: sentenceFieldSelect.value,
                definitionField: definitionFieldSelect.value,
                audioField: audioFieldSelect.value,
                imageField: imageFieldSelect.value,
                languageMode: currentLanguageMode,
                mediaType: currentMediaType
            };
            localStorage.setItem('ankiConfig', JSON.stringify(config));
        }

        // ä»localStorageåŠ è½½é…ç½®
        function loadConfig() {
            const savedConfig = localStorage.getItem('ankiConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    if (config.deck) deckSelect.value = config.deck;
                    if (config.model) modelSelect.value = config.model;
                    if (config.wordField) wordFieldSelect.value = config.wordField;
                    if (config.sentenceField) sentenceFieldSelect.value = config.sentenceField;
                    if (config.definitionField) definitionFieldSelect.value = config.definitionField;
                    if (config.audioField) audioFieldSelect.value = config.audioField;
                    if (config.imageField) imageFieldSelect.value = config.imageField;
                    if (config.languageMode) {
                        currentLanguageMode = config.languageMode;
                        updateLanguageModeButton();
                    }
                    if (config.mediaType) {
                        currentMediaType = config.mediaType;
                        updateMediaModeButton();
                    }
                } catch (e) {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                }
            }
        }

        // æ›´æ–°è¯­è¨€æ¨¡å¼æŒ‰é’®æ–‡æœ¬
        function updateLanguageModeButton() {
            languageModeBtn.innerHTML = currentLanguageMode === 'english' ? 
                '<i class="fas fa-language"></i> è‹±è¯­æ¨¡å¼' : 
                '<i class="fas fa-language"></i> æ—¥è¯­æ¨¡å¼';
        }

        // æ›´æ–°åª’ä½“æ¨¡å¼æŒ‰é’®æ–‡æœ¬
        function updateMediaModeButton() {
            mediaModeBtn.innerHTML = currentMediaType === 'video' ? 
                '<i class="fas fa-video"></i> è§†é¢‘æ¨¡å¼' : 
                '<i class="fas fa-music"></i> éŸ³é¢‘æ¨¡å¼';
            updateImportButton();
        }

        // æ›´æ–°å¯¼å…¥æŒ‰é’®æ–‡æœ¬
        function updateImportButton() {
            mediaImportBtn.innerHTML = currentMediaType === 'video' ? 
                '<i class="fas fa-file-video"></i> è§†é¢‘' : 
                '<i class="fas fa-file-audio"></i> éŸ³é¢‘';
        }

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶å¤„ç†
        subtitleImportBtn.addEventListener('click', () => {
            subtitleFileInput.click();
        });
        
        mediaImportBtn.addEventListener('click', () => {
            if (currentMediaType === 'video') {
                videoFileInput.click();
            } else {
                audioFileInput.click();
            }
        });
        
        // ğŸ¬ è§†é¢‘æ–‡ä»¶åŠ è½½
        videoFileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            currentMediaFile = file;
            currentMediaType = 'video';
            trackTitle.textContent = file.name.replace(/\.[^/.]+$/, "");
            trackDescription.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            mediaIcon.className = 'fas fa-video';

            // æš‚åœéŸ³é¢‘æ’­æ”¾å™¨ï¼ˆå¦‚æœæ­£åœ¨æ’­æ”¾ï¼‰
            if (audioElement && !audioElement.paused) {
                audioElement.pause();
                audioPlayPauseBtn.textContent = 'â–¶';
            }

            // åˆ›å»ºè§†é¢‘URLå¹¶è®¾ç½®æ’­æ”¾å™¨
            const fileURL = URL.createObjectURL(file);
            videoPlayer.src = fileURL;

            // åˆ‡æ¢è§†é¢‘æ¨¡å¼
            switchToVideoMode();
            videoPlayerContainer.classList.add('active');

            // é‡ç½®å­—å¹•
            subtitles = [];
            subtitleText.innerHTML = "æ— å­—å¹•";
            videoSubtitles.innerHTML = "";
            updateSubtitleList();

            // å°è¯•åŠ è½½éŸ³é¢‘ç¼“å†²ï¼ˆå¦‚æœè§†é¢‘ä¸­æœ‰éŸ³è½¨ï¼‰
            await loadAudioBuffer(file);
        });
                
        async function loadAudioFile(file) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

            try {
                if (file.type.startsWith('audio/')) {
                    const arrayBuffer = await file.arrayBuffer();
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    console.log('éŸ³é¢‘æ–‡ä»¶åŠ è½½å®Œæˆ', audioBuffer);
                } else if (file.type.startsWith('video/')) {
                    const arrayBuffer = await extractAudioFromVideoBlob(file);
                    audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    console.log('è§†é¢‘éŸ³è½¨æå–å®Œæˆ', audioBuffer);
                } else {
                    throw new Error('ä¸æ”¯æŒçš„åª’ä½“ç±»å‹');
                }
            } catch (e) {
                console.error('åŠ è½½éŸ³é¢‘å¤±è´¥:', e);
                audioBuffer = null;
            }
        }

        async function extractAudioFromVideoBlob(videoBlob) {
            return new Promise((resolve, reject) => {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(videoBlob);
                video.muted = true;
                video.play();

                video.onloadedmetadata = () => {
                    const stream = video.captureStream();
                    if (stream.getAudioTracks().length === 0) return reject('è§†é¢‘æ²¡æœ‰éŸ³è½¨');

                    const recorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                    const chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = async () => {
                        const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                        resolve(await audioBlob.arrayBuffer());
                    };
                    recorder.start();
                    setTimeout(() => recorder.stop(), (video.duration || 1) * 1000); 
                };
                video.onerror = e => reject(e);
            });
        }


        // ğŸµ éŸ³é¢‘æ–‡ä»¶åŠ è½½
        audioFileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            currentMediaFile = file;
            currentMediaType = 'audio';
            trackTitle.textContent = file.name.replace(/\.[^/.]+$/, "");
            trackDescription.textContent = `æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            mediaIcon.className = 'fas fa-music';

            // åˆ›å»ºéŸ³é¢‘URLå¹¶è®¾ç½®æ’­æ”¾å™¨
            const fileURL = URL.createObjectURL(file);
            audioElement.src = fileURL;

            // å…³é—­è§†é¢‘æ¨¡å¼
            videoPlayerContainer.classList.remove('active');

            // åŠ è½½éŸ³é¢‘ç¼“å†²
            await loadAudioBuffer(file);
        });
                
        // åˆå§‹åŒ–éŸ³é¢‘æ§ä»¶
        function initAudioControls() {
            // æ›´æ–°éŸ³é¢‘æ—¶é•¿
            audioElement.addEventListener('loadedmetadata', () => {
                audioDuration.textContent = formatTime(audioElement.duration);
                updateProgressThumb();
                updateVolumeThumb();
            });
            
            // æ’­æ”¾/æš‚åœæŒ‰é’®
            audioPlayPauseBtn.addEventListener('click', () => {
                if (audioElement.paused) {
                    audioElement.play();
                    audioPlayPauseBtn.textContent = 'â¸';
                    audioPlayPauseBtn.classList.add('active');
                } else {
                    audioElement.pause();
                    audioPlayPauseBtn.textContent = 'â–¶';
                    audioPlayPauseBtn.classList.remove('active');
                }
            });
            
            // è¿›åº¦æ¡ç‚¹å‡»
            audioProgress.addEventListener('click', (e) => {
                const rect = audioProgress.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioElement.currentTime = percent * audioElement.duration;
                updateProgressThumb();
            });
            
            // è¿›åº¦æ¡æ‹–åŠ¨
            progressThumb.addEventListener('mousedown', startDragProgress);
            progressThumb.addEventListener('touchstart', startDragProgress);
            
            // éŸ³é‡æ¡ç‚¹å‡»
            audioVolume.addEventListener('click', (e) => {
                const rect = audioVolume.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                audioElement.volume = percent;
                updateVolumeThumb();
            });
            
            // éŸ³é‡æ¡æ‹–åŠ¨
            volumeThumb.addEventListener('mousedown', startDragVolume);
            volumeThumb.addEventListener('touchstart', startDragVolume);
            
            // æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
            audioElement.addEventListener('timeupdate', () => {
                const percent = (audioElement.currentTime / audioElement.duration) * 100;
                audioProgressFilled.style.width = `${percent}%`;
                audioCurrentTime.textContent = formatTime(audioElement.currentTime);
                
                if (!isDraggingProgress) {
                    updateProgressThumb();
                }
                
                // æ›´æ–°éŸ³é¢‘å­—å¹•
                updateAudioSubtitles();
            });
            
            // éŸ³é¢‘æ’­æ”¾çŠ¶æ€å˜åŒ–
            audioElement.addEventListener('play', () => {
                audioPlayPauseBtn.textContent = 'â¸';
                audioPlayPauseBtn.classList.add('active');
            });
            
            audioElement.addEventListener('pause', () => {
                audioPlayPauseBtn.textContent = 'â–¶';
                audioPlayPauseBtn.classList.remove('active');
            });
            
            // æ›´æ–°éŸ³é¢‘å­—å¹•
            audioElement.addEventListener('timeupdate', () => {
                updateSubtitle(audioElement.currentTime);
            });
        }
        
        // å¼€å§‹æ‹–åŠ¨è¿›åº¦æ¡
        function startDragProgress(e) {
            e.preventDefault();
            isDraggingProgress = true;
            
            const moveHandler = (e) => {
                if (!isDraggingProgress) return;
                
                const rect = audioProgress.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                let percent = (clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                audioElement.currentTime = percent * audioElement.duration;
                updateProgressThumb();
            };
            
            const upHandler = () => {
                isDraggingProgress = false;
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
                document.removeEventListener('touchend', upHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchend', upHandler);
        }
        
        // å¼€å§‹æ‹–åŠ¨éŸ³é‡æ¡
        function startDragVolume(e) {
            e.preventDefault();
            isDraggingVolume = true;
            
            const moveHandler = (e) => {
                if (!isDraggingVolume) return;
                
                const rect = audioVolume.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                let percent = (clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                audioElement.volume = percent;
                updateVolumeThumb();
            };
            
            const upHandler = () => {
                isDraggingVolume = false;
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
                document.removeEventListener('touchend', upHandler);
            };
            
            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('touchmove', moveHandler);
            document.addEventListener('mouseup', upHandler);
            document.addEventListener('touchend', upHandler);
        }
        
        // æ›´æ–°è¿›åº¦æ¡æ»‘å—ä½ç½®
        function updateProgressThumb() {
            if (!audioElement.duration) return;
            const percent = (audioElement.currentTime / audioElement.duration) * 100;
            progressThumb.style.left = `${percent}%`;
        }
        
        // æ›´æ–°éŸ³é‡æ»‘å—ä½ç½®
        function updateVolumeThumb() {
            const percent = audioElement.volume * 100;
            audioVolumeFilled.style.width = `${percent}%`;
            volumeThumb.style.left = `${percent}%`;
        }
        
        // åˆ‡æ¢åˆ°è§†é¢‘æ¨¡å¼
        function switchToVideoMode() {
            currentMediaType = 'video';
            updateMediaModeButton();
            videoPlayerContainer.classList.add('active');
            audioPlayerContainer.classList.remove('active');
            updateControlButtons();
        }
        
        // åˆ‡æ¢åˆ°éŸ³é¢‘æ¨¡å¼
        function switchToAudioMode() {
            currentMediaType = 'audio';
            updateMediaModeButton();
            audioPlayerContainer.classList.add('active');
            videoPlayerContainer.classList.remove('active');
            updateControlButtons();
        }
        
        // æ›´æ–°æ§åˆ¶æŒ‰é’®æ˜¾ç¤º
        function updateControlButtons() {
            // è§†é¢‘ç›¸å…³æŒ‰é’®
            const videoControls = [toggleVideoSubtitlesBtn];
            // éŸ³é¢‘ç›¸å…³æŒ‰é’®
            const audioControls = [toggleAudioSubtitlesBtn];
            
            if (currentMediaType === 'video') {
                videoControls.forEach(btn => btn.style.display = 'flex');
                audioControls.forEach(btn => btn.style.display = 'none');
            } else {
                videoControls.forEach(btn => btn.style.display = 'none');
                audioControls.forEach(btn => btn.style.display = 'flex');
            }
        }
        
        // åˆ‡æ¢è¯­è¨€æ¨¡å¼
        function toggleLanguageMode() {
            currentLanguageMode = currentLanguageMode === 'english' ? 'japanese' : 'english';
            updateLanguageModeButton();
            saveConfig();
        }
        
        // åˆ‡æ¢åª’ä½“æ¨¡å¼
        function toggleMediaMode() {
            currentMediaType = currentMediaType === 'video' ? 'audio' : 'video';
            updateMediaModeButton();
            saveConfig();
            
            // å¦‚æœå·²æœ‰åª’ä½“æ–‡ä»¶ï¼Œåˆ‡æ¢åˆ°å¯¹åº”çš„æ’­æ”¾å™¨
            if (currentMediaFile) {
                if (currentMediaType === 'video') {
                    switchToVideoMode();
                } else {
                    switchToAudioMode();
                }
            }
        }
        
        // æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        mediaModeBtn.addEventListener('click', toggleMediaMode);
        
        // è¯­è¨€æ¨¡å¼åˆ‡æ¢äº‹ä»¶
        languageModeBtn.addEventListener('click', toggleLanguageMode);
        
        // åˆ‡æ¢éŸ³é¢‘å­—å¹•æ˜¾ç¤º
        toggleAudioSubtitlesBtn.addEventListener('click', () => {
            audioSubtitlesVisible = !audioSubtitlesVisible;
            if (audioSubtitlesVisible) {
                audioSubtitles.classList.add('active');
            } else {
                audioSubtitles.classList.remove('active');
            }
        });
        
        // è‡ªé€‚åº”åŠ è½½éŸ³é¢‘ç¼“å†²ï¼ˆæ— è®ºæ˜¯éŸ³é¢‘æˆ–è§†é¢‘ï¼‰
        async function loadAudioBuffer(file) {
            const ctx = getAudioContext();

            // è¯»å–æ–‡ä»¶ä¸º ArrayBuffer
            const arrayBuffer = await file.arrayBuffer();

            try {
                // å°è¯•è§£ç éŸ³é¢‘ï¼ˆå³ä¾¿æ˜¯è§†é¢‘ï¼Œä¹Ÿå¯èƒ½æˆåŠŸæå–éŸ³è½¨ï¼‰
                audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                console.log("âœ… éŸ³é¢‘ç¼“å†²åŠ è½½æˆåŠŸ:", audioBuffer);
            } catch (err) {
                console.warn("âš  æ— æ³•ç›´æ¥ä»æ–‡ä»¶æå–éŸ³é¢‘:", err);
                audioBuffer = null;
            }
        }
                
        // å­—å¹•æ–‡ä»¶é€‰æ‹©å¤„ç†
        subtitleFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    parseSubtitle(content);
                };
                reader.readAsText(file);
            }
        });
        
        // è§£æå­—å¹•æ–‡ä»¶ï¼ˆç®€å•SRTæ ¼å¼è§£æï¼‰
        function parseSubtitle(content) {
            subtitles = [];
            
            // ç®€å•çš„SRTè§£æå™¨
            const blocks = content.split(/\n\s*\n/);
            
            blocks.forEach(block => {
                const lines = block.trim().split('\n');
                if (lines.length >= 3) {
                    // ç¬¬ä¸€è¡Œæ˜¯åºå·ï¼Œè·³è¿‡
                    // ç¬¬äºŒè¡Œæ˜¯æ—¶é—´è½´
                    const timeLine = lines[1];
                    const timeMatch = timeLine.match(/(\d+):(\d+):(\d+),(\d+)\s*-->\s*(\d+):(\d+):(\d+),(\d+)/);
                    
                    if (timeMatch) {
                        const startTime = 
                            parseInt(timeMatch[1]) * 3600 + 
                            parseInt(timeMatch[2]) * 60 + 
                            parseInt(timeMatch[3]) + 
                            parseInt(timeMatch[4]) / 1000;
                        
                        const endTime = 
                            parseInt(timeMatch[5]) * 3600 + 
                            parseInt(timeMatch[6]) * 60 + 
                            parseInt(timeMatch[7]) + 
                            parseInt(timeMatch[8]) / 1000;
                        
                        // ç¬¬ä¸‰è¡ŒåŠä¹‹åæ˜¯å­—å¹•æ–‡æœ¬
                        const text = lines.slice(2).join(' ').trim();
                        
                        if (text) {
                            subtitles.push({
                                start: startTime,
                                end: endTime,
                                text: text
                            });
                        }
                    }
                }
            });
            
            // æŒ‰å¼€å§‹æ—¶é—´æ’åº
            subtitles.sort((a, b) => a.start - b.start);
            
            // æ›´æ–°å­—å¹•åˆ—è¡¨
            updateSubtitleList();
            updateAudioSubtitles();
            
            // æ›´æ–°åˆå§‹å­—å¹•æ˜¾ç¤º
            updateSubtitle(0);
        }

        // æ›´æ–°å­—å¹•åˆ—è¡¨
        function updateSubtitleList() {
            subtitleList.innerHTML = '';
            
            if (subtitles.length === 0) {
                const emptyItem = document.createElement('li');
                emptyItem.className = 'subtitle-item';
                emptyItem.textContent = 'æ— å­—å¹•';
                subtitleList.appendChild(emptyItem);
                return;
            }
            
            subtitles.forEach((subtitle, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'subtitle-item';
                listItem.textContent = `${formatTime(subtitle.start)} - ${formatTime(subtitle.end)}: ${subtitle.text}`;
                listItem.addEventListener('click', () => {
                    // è·³è½¬åˆ°è¯¥å­—å¹•å¼€å§‹æ—¶é—´
                    if (currentMediaType === 'video') {
                        videoPlayer.currentTime = subtitle.start;
                    } else {
                        audioElement.currentTime = subtitle.start;
                    }
                    currentSubtitleIndex = index;
                    updateActiveSubtitleItem();
                    closeSubtitleListPanelFunc();
                });
                subtitleList.appendChild(listItem);
            });
            
            updateActiveSubtitleItem();
        }
        
        // æ›´æ–°éŸ³é¢‘æ»šåŠ¨å­—å¹•
        function updateAudioSubtitles() {
            audioSubtitles.innerHTML = '';
            
            if (subtitles.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'audio-subtitle-item';
                emptyItem.textContent = 'æ— å­—å¹•';
                audioSubtitles.appendChild(emptyItem);
                return;
            }
            
            subtitles.forEach((subtitle, index) => {
                const subtitleItem = document.createElement('div');
                subtitleItem.className = 'audio-subtitle-item';
                if (index === currentSubtitleIndex) {
                    subtitleItem.classList.add('active');
                }
                
                // æ ¹æ®è¯­è¨€æ¨¡å¼åˆ›å»ºå¯ç‚¹å‡»çš„å†…å®¹
                if (currentLanguageMode === 'english') {
                    // è‹±è¯­æ¨¡å¼ï¼šåˆ›å»ºå¯ç‚¹å‡»çš„å•è¯
                    const text = subtitle.text;
                    const wordRegex = /[a-zA-Z]+(?:[''â€™][a-zA-Z]+)*/g;
                    let lastIndex = 0;
                    let clickableWords = '';
                    
                    let match;
                    while ((match = wordRegex.exec(text)) !== null) {
                        // æ·»åŠ åŒ¹é…å‰çš„éå•è¯éƒ¨åˆ†
                        clickableWords += text.substring(lastIndex, match.index);
                        
                        // æ·»åŠ å¯ç‚¹å‡»çš„å•è¯
                        clickableWords += `<span class="word" data-word="${match[0]}">${match[0]}</span>`;
                        
                        lastIndex = match.index + match[0].length;
                    }
                    
                    // æ·»åŠ å‰©ä½™çš„éå•è¯éƒ¨åˆ†
                    clickableWords += text.substring(lastIndex);
                    
                    subtitleItem.innerHTML = clickableWords;
                } else {
                    // æ—¥è¯­æ¨¡å¼ï¼šæ˜¾ç¤ºåŸå§‹æ–‡æœ¬ï¼Œç‚¹å‡»æ•´ä¸ªå¥å­
                    subtitleItem.textContent = subtitle.text;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                subtitleItem.addEventListener('click', (e) => {
                    if (currentLanguageMode === 'english') {
                        // è‹±è¯­æ¨¡å¼ï¼šç‚¹å‡»å•è¯æŸ¥è¯¢
                        if (e.target.classList.contains('word')) {
                            const word = e.target.getAttribute('data-word');
                            
                            // ç‚¹å‡»å•è¯æ—¶æš‚åœæ’­æ”¾
                            if (currentMediaType === 'audio') {
                                playerWasPlaying = !audioElement.paused;
                                audioElement.pause();
                            }
                            
                            // æŸ¥è¯¢å•è¯å¹¶æ˜¾ç¤ºåº•éƒ¨é¢æ¿
                            searchWordInPanel(word);
                            
                            // è®°å½•å½“å‰å•è¯å’Œå¥å­
                            currentWord = word;
                            if (currentSubtitleIndex >= 0) {
                                currentSentence = subtitles[currentSubtitleIndex].text;
                                
                                // æ›´æ–°åŸå¥æ˜¾ç¤º
                                updateOriginalSentence(currentSentence, word);
                            }
                        }
                    } else {
                        // æ—¥è¯­æ¨¡å¼ï¼šç‚¹å‡»å¥å­ï¼Œæ˜¾ç¤ºåˆ†è¯ç»“æœ
                        const sentence = subtitle.text;
                        
                        // ç‚¹å‡»å¥å­æ—¶æš‚åœæ’­æ”¾
                        if (currentMediaType === 'audio') {
                            playerWasPlaying = !audioElement.paused;
                            audioElement.pause();
                        }
                        
                        // æ˜¾ç¤ºæ—¥è¯­åˆ†è¯ç»“æœ
                        showJapaneseWordSegmentation(sentence);
                        
                        // è®°å½•å½“å‰å¥å­
                        currentSentence = sentence;
                    }
                });
                
                audioSubtitles.appendChild(subtitleItem);
            });
            
            // æ»šåŠ¨åˆ°å½“å‰å­—å¹•ï¼ˆä½†ä¸å¼ºåˆ¶æ»šåŠ¨é¡µé¢ï¼‰
            if (currentSubtitleIndex >= 0) {
                const activeItem = audioSubtitles.children[currentSubtitleIndex];
                if (activeItem) {
                    // ä½¿ç”¨å¹³æ»‘æ»šåŠ¨ï¼Œä½†ä¸å¼ºåˆ¶æ»šåŠ¨æ•´ä¸ªé¡µé¢
                    activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }
        
        // æ—¥è¯­åˆ†è¯æ˜¾ç¤º
        async function showJapaneseWordSegmentation(sentence, currentWord = '') {
            if (!tokenizer) {
                console.error('åˆ†è¯å™¨æœªåˆå§‹åŒ–');
                return;
            }

            try {
                const result = tokenizer.tokenize(sentence);
                const japaneseWords = result.map(item => item.surface_form);

                // æ‰“å¼€å­—å…¸é¢æ¿
                openDictionaryPanel();

                // æ›´æ–°åŸå¥æ˜¾ç¤ºï¼Œä½¿ç”¨æ—¥è¯­åˆ†è¯å—
                updateOriginalSentence(sentence, currentWord, 'japanese', japaneseWords);

                // ä¸ºå­—å…¸é¢æ¿åˆ†è¯ç»‘å®šç‚¹å‡»äº‹ä»¶
                panelDictionaryResult.querySelectorAll('.word').forEach(wordElement => {
                    wordElement.addEventListener('click', () => {
                        const word = wordElement.getAttribute('data-word');
                        const index = parseInt(wordElement.getAttribute('data-index'));
                        panelDictionaryResult.querySelectorAll('.word').forEach(w => w.classList.remove('highlight'));
                        wordElement.classList.add('highlight');
                        panelSearchInput.value = word;
                        if (window.japaneseWordClicked) {
                            window.japaneseWordClicked(word, index);
                        } else {
                            searchJapaneseWordInPanel(word);
                        }
                    });
                });

                panelWordTitle.textContent = `æ—¥è¯­åˆ†è¯`;

                // åˆ†è¯å®Œæˆå›è°ƒ
                if (window.japaneseSegmentationComplete) {
                    window.japaneseSegmentationComplete(sentence, japaneseWords);
                }

            } catch (error) {
                console.error('æ—¥è¯­åˆ†è¯å¤±è´¥:', error);
                panelDictionaryResult.innerHTML = `<div class="error">æ—¥è¯­åˆ†è¯å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æŸ¥è¯¢æ—¥è¯­å•è¯
        async function searchJapaneseWordInPanel(word) {
            if (!word.trim()) {
                panelDictionaryResult.innerHTML = '<div class="error">è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å•è¯</div>';
                return;
            }
            
            // ç¡®ä¿é¢æ¿å·²æ‰“å¼€
            openDictionaryPanel();
            
            panelDictionaryResult.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
            panelWordTitle.textContent = `æŸ¥è¯¢: ${word}`;
            panelSearchInput.value = word;
            
            // æ²¹çŒ´è„šæœ¬æ¥å£ï¼šæ—¥è¯­æŸ¥è¯¢å›è°ƒ
            if (window.japaneseWordSearch) {
                window.japaneseWordSearch(word);
            } else {
                // é»˜è®¤è¡Œä¸ºï¼šä½¿ç”¨Jisho APIæŸ¥è¯¢æ—¥è¯­å•è¯
                try {
                    const response = await fetch(`https://jisho.org/api/v1/search/words?keyword=${encodeURIComponent(word)}`);
                    
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    displayJapaneseWordDataInPanel(data);
                } catch (error) {
                    panelDictionaryResult.innerHTML = `<div class="error">${error.message}</div>`;
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                }
            }
        }
        
        // æ˜¾ç¤ºæ—¥è¯­å•è¯æ•°æ®åœ¨åº•éƒ¨é¢æ¿
        function displayJapaneseWordDataInPanel(wordData) {
            let html = '';
            
            if (wordData.data && wordData.data.length > 0) {
                const word = wordData.data[0];
                
                // å•è¯æ ‡é¢˜å’Œè¯»éŸ³
                html += `<div class="word-header">`;
                html += `<div class="word-title">${word.japanese[0].word || word.japanese[0].reading}</div>`;
                
                if (word.japanese[0].reading) {
                    html += `<div class="phonetic">${word.japanese[0].reading}</div>`;
                }
                
                html += `</div>`;
                
                // è¯ä¹‰è§£é‡Š
                if (word.senses && word.senses.length > 0) {
                    word.senses.forEach((sense, index) => {
                        if (index < 3) { // åªæ˜¾ç¤ºå‰ä¸‰ä¸ªå®šä¹‰
                            html += `<div class="meaning-section">`;
                            html += `<div class="part-of-speech">${sense.parts_of_speech.join(', ')}</div>`;
                            
                            if (sense.english_definitions && sense.english_definitions.length > 0) {
                                sense.english_definitions.forEach((def, defIndex) => {
                                    if (defIndex < 3) { // åªæ˜¾ç¤ºå‰ä¸‰ä¸ªè‹±æ–‡å®šä¹‰
                                        html += `<div class="definition">${defIndex + 1}. ${def}</div>`;
                                    }
                                });
                            }
                            
                            html += `</div>`;
                        }
                    });
                } else {
                    html += `<div class="meaning-section">`;
                    html += `<div class="definition">æœªæ‰¾åˆ°è¯¥å•è¯çš„è¯¦ç»†é‡Šä¹‰ã€‚</div>`;
                    html += `</div>`;
                }
            } else {
                html += `<div class="meaning-section">`;
                html += `<div class="definition">æœªæ‰¾åˆ°è¯¥å•è¯çš„è¯¦ç»†é‡Šä¹‰ã€‚</div>`;
                html += `</div>`;
            }
            
            panelDictionaryResult.innerHTML = html;
        }
        
        // æ›´æ–°å½“å‰æ¿€æ´»çš„å­—å¹•é¡¹
        function updateActiveSubtitleItem() {
            const items = subtitleList.querySelectorAll('.subtitle-item');
            items.forEach((item, index) => {
                if (index === currentSubtitleIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // æ›´æ–°éŸ³é¢‘æ»šåŠ¨å­—å¹•
            const audioItems = audioSubtitles.querySelectorAll('.audio-subtitle-item');
            audioItems.forEach((item, index) => {
                if (index === currentSubtitleIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // æ›´æ–°å­—å¹•æ˜¾ç¤º
        function updateSubtitle(currentTime) {
            if (subtitles.length === 0) {
                subtitleText.innerHTML = "æ— å­—å¹•";
                videoSubtitles.innerHTML = "";
                return;
            }
            
            // æŸ¥æ‰¾å½“å‰æ—¶é—´å¯¹åº”çš„å­—å¹•
            let foundIndex = -1;
            for (let i = 0; i < subtitles.length; i++) {
                if (currentTime >= subtitles[i].start && currentTime < subtitles[i].end) {
                    foundIndex = i;
                    break;
                }
            }
            
            if (foundIndex !== -1) {
                const currentSubtitle = subtitles[foundIndex];
                currentSubtitleIndex = foundIndex;
                
                // æ›´æ–°è§†é¢‘å†…å­—å¹•
                if (videoSubtitlesVisible && currentMediaType === 'video') {
                    videoSubtitles.innerHTML = `<span>${currentSubtitle.text}</span>`;
                } else {
                    videoSubtitles.innerHTML = "";
                }
                
                // æ”¹è¿›çš„å­—å¹•æ–‡æœ¬è½¬æ¢
                const text = currentSubtitle.text;
                
                if (currentLanguageMode === 'english') {
                    // è‹±è¯­æ¨¡å¼ï¼šåˆ›å»ºå¯ç‚¹å‡»çš„å•è¯
                    const wordRegex = /[a-zA-Z]+(?:[''â€™][a-zA-Z]+)*/g;
                    let lastIndex = 0;
                    let clickableWords = '';
                    
                    let match;
                    while ((match = wordRegex.exec(text)) !== null) {
                        // æ·»åŠ åŒ¹é…å‰çš„éå•è¯éƒ¨åˆ†
                        clickableWords += text.substring(lastIndex, match.index);
                        
                        // æ·»åŠ å¯ç‚¹å‡»çš„å•è¯
                        clickableWords += `<span class="word" data-word="${match[0]}">${match[0]}</span>`;
                        
                        lastIndex = match.index + match[0].length;
                    }
                    
                    // æ·»åŠ å‰©ä½™çš„éå•è¯éƒ¨åˆ†
                    clickableWords += text.substring(lastIndex);
                    
                    subtitleText.innerHTML = clickableWords;
                    
                    // ä¿®å¤ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜è§£å†³å•è¯ç‚¹å‡»é—®é¢˜
                    subtitleText.removeEventListener('click', handleWordClick);
                    subtitleText.addEventListener('click', handleWordClick);
                } else {
                    // æ—¥è¯­æ¨¡å¼ï¼šæ˜¾ç¤ºåŸå§‹æ–‡æœ¬
                    subtitleText.innerHTML = text;
                    
                    // æ—¥è¯­æ¨¡å¼ä¸‹ç‚¹å‡»æ•´ä¸ªå¥å­
                    subtitleText.addEventListener('click', () => {
                        // ç‚¹å‡»å¥å­æ—¶æš‚åœæ’­æ”¾
                        if (currentMediaType === 'video') {
                            playerWasPlaying = !videoPlayer.paused;
                            videoPlayer.pause();
                        } else {
                            playerWasPlaying = !audioElement.paused;
                            audioElement.pause();
                        }
                        
                        // æ˜¾ç¤ºæ—¥è¯­åˆ†è¯ç»“æœ
                        showJapaneseWordSegmentation(text);
                        
                        // è®°å½•å½“å‰å¥å­
                        currentSentence = text;
                    });
                }
                
                subtitleText.style.opacity = '1';
                
            } else {
                // ä¸åœ¨ä»»ä½•å­—å¹•æ—¶é—´èŒƒå›´å†…ï¼Œæ˜¾ç¤ºç°è‰²çŠ¶æ€
                subtitleText.style.opacity = '0.5';
                videoSubtitles.innerHTML = "";
                currentSubtitleIndex = -1;
            }
            
            updateActiveSubtitleItem();
            
            // æ›´æ–°éŸ³é¢‘æ»šåŠ¨å­—å¹•
            if (currentMediaType === 'audio') {
                updateAudioSubtitles();
            }
        }

        // ä¿®å¤ï¼šä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†å•è¯ç‚¹å‡»
        function handleWordClick(e) {
            if (e.target.classList.contains('word')) {
                const word = e.target.getAttribute('data-word');
                
                // ç‚¹å‡»å•è¯æ—¶æš‚åœæ’­æ”¾
                if (currentMediaType === 'video') {
                    playerWasPlaying = !videoPlayer.paused;
                    videoPlayer.pause();
                } else {
                    playerWasPlaying = !audioElement.paused;
                    audioElement.pause();
                }
                
                // æŸ¥è¯¢å•è¯å¹¶æ˜¾ç¤ºåº•éƒ¨é¢æ¿
                searchWordInPanel(word);
                
                // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„å•è¯
                if (currentHighlightedWord) {
                    currentHighlightedWord.classList.remove('highlight');
                }
                e.target.classList.add('highlight');
                currentHighlightedWord = e.target;
                
                // è®°å½•å½“å‰å•è¯å’Œå¥å­
                currentWord = word;
                if (currentSubtitleIndex >= 0) {
                    currentSentence = subtitles[currentSubtitleIndex].text;
                    
                    // æ›´æ–°åŸå¥æ˜¾ç¤º
                    updateOriginalSentence(currentSentence, word);
                }
            }
        }

        // æ›´æ–°åŸå¥æ˜¾ç¤ºï¼Œä½¿å•è¯/åˆ†è¯å¯ç‚¹å‡»ï¼Œå¢åŠ ç‚¹å‡»æ—¶ç›´æ¥è¿½åŠ åˆ° appendedWords
        function updateOriginalSentence(sentence, currentWord, currentLanguageMode = 'english', japaneseWords = []) {
            let clickableSentence = '';

            // æ ¹æ®è¯­è¨€æ¨¡å¼è·å–è¯å—
            const words = currentLanguageMode === 'japanese' && japaneseWords.length > 0 
                ? japaneseWords 
                : sentence.match(/\S+/g) || []; // è‹±æ–‡æˆ–å…¶ä»–è¯­è¨€æŒ‰ç©ºç™½åˆ†è¯

            words.forEach((word, index) => {
                const wordClass = appendedWords.includes(word) ? 'sentence-word highlight' : 'sentence-word';

                // è‹±æ–‡æ¨¡å¼åŠ ç©ºæ ¼ï¼Œæ—¥è¯­æ¨¡å¼ä¸åŠ 
                const space = currentLanguageMode === 'japanese' ? '' : '&nbsp;';

                clickableSentence += `<span class="${wordClass}" data-word="${word}" data-index="${index}">${word}</span>${space}`;
            });

            originalSentence.innerHTML = clickableSentence;

            // ç‚¹å‡»è¯å—ç«‹å³æœç´¢å¹¶é«˜äº®
            originalSentence.removeEventListener('click', handleSentenceWordClick);
            // ç‚¹å‡»å¥å­è¯å—ç«‹å³æœç´¢
            originalSentence.addEventListener('click', (e) => {
                const span = e.target.closest('.sentence-word');
                if (!span) return;

                const word = span.getAttribute('data-word');
                const index = parseInt(span.getAttribute('data-index'));

                // å•å‡»è¯å— â†’ é‡ç½®å·²é€‰è¯ï¼Œåªä¿ç•™å½“å‰ç‚¹å‡»è¯
                appendedWords = [word];
                currentWordIndex = index;
                panelSearchInput.value = word;

                // æ›´æ–°é«˜äº®
                originalSentence.querySelectorAll('.sentence-word').forEach((s) => {
                    s.classList.toggle('highlight', appendedWords.includes(s.getAttribute('data-word')));
                });

                // ç«‹å³è§¦å‘è¯å…¸æœç´¢
                if (currentLanguageMode === 'english') {
                    searchWordInPanel(word);
                } else {
                    searchJapaneseWordInPanel(word);
                }

                // å¦‚æœå½“å‰æ¿€æ´»æ ‡ç­¾é¡µæ˜¯ç½‘é¡µæŸ¥è¯¢ï¼Œåˆ™è‡ªåŠ¨åŠ è½½ç½‘é¡µ
                if (activeTab === 'web-tab') {
                    loadWebSearch(word);
                }
            });
        }

        // å¤„ç†åŸå¥ä¸­å•è¯ç‚¹å‡»
        function handleSentenceWordClick(e) {
            if (e.target.classList.contains('sentence-word')) {
                const word = e.target.getAttribute('data-word');
                panelSearchInput.value = word;
                searchWordInPanel(word);
                
                // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„å•è¯
                document.querySelectorAll('.sentence-word').forEach(w => {
                    w.classList.remove('highlight');
                });
                e.target.classList.add('highlight');
                
                // æ›´æ–°å½“å‰å•è¯
                currentWord = word;
            }
        }

        // åœ¨é¢æ¿ä¸­æŸ¥è¯¢å•è¯
        async function searchWordInPanel(word) {
            if (!word.trim()) {
                panelDictionaryResult.innerHTML = '<div class="error">è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å•è¯</div>';
                return;
            }
            
            // ç¡®ä¿é¢æ¿å·²æ‰“å¼€
            openDictionaryPanel();
            
            panelDictionaryResult.innerHTML = '<div class="loading">æŸ¥è¯¢ä¸­...</div>';
            panelWordTitle.textContent = `æŸ¥è¯¢: ${word}`;
            panelSearchInput.value = word;
            
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error(`æœªæ‰¾åˆ°å•è¯ "${word}" çš„å®šä¹‰`);
                    } else {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                    }
                }
                
                const data = await response.json();
                displayWordDataInPanel(data[0]);
            } catch (error) {
                panelDictionaryResult.innerHTML = `<div class="error">${error.message}</div>`;
                console.error('æŸ¥è¯¢é”™è¯¯:', error);
            }
        }
        
        // æ˜¾ç¤ºå•è¯æ•°æ®åœ¨åº•éƒ¨é¢æ¿
        function displayWordDataInPanel(wordData) {
            let html = '';
            
            // å•è¯æ ‡é¢˜å’ŒéŸ³æ ‡
            html += `<div class="word-header">`;
            html += `<div class="word-title">${wordData.word}</div>`;
            
            if (wordData.phonetic) {
                html += `<div class="phonetic">${wordData.phonetic}</div>`;
            } else if (wordData.phonetics && wordData.phonetics.length > 0) {
                const phonetic = wordData.phonetics.find(p => p.text) || wordData.phonetics[0];
                if (phonetic && phonetic.text) {
                    html += `<div class="phonetic">${phonetic.text}</div>`;
                }
            }
            
            html += `</div>`;
            
            // è¯ä¹‰è§£é‡Š
            if (wordData.meanings && wordData.meanings.length > 0) {
                wordData.meanings.forEach(meaning => {
                    html += `<div class="meaning-section">`;
                    html += `<div class="part-of-speech">${meaning.partOfSpeech}</div>`;
                    
                    if (meaning.definitions && meaning.definitions.length > 0) {
                        meaning.definitions.forEach((def, index) => {
                            if (index < 3) { // åªæ˜¾ç¤ºå‰ä¸‰ä¸ªå®šä¹‰
                                html += `<div class="definition">${index + 1}. ${def.definition}</div>`;
                                if (def.example) {
                                    html += `<div class="example">ä¾‹å¥: "${def.example}"</div>`;
                                }
                            }
                        });
                    }
                    
                    html += `</div>`;
                });
            } else {
                html += `<div class="meaning-section">`;
                html += `<div class="definition">æœªæ‰¾åˆ°è¯¥å•è¯çš„è¯¦ç»†é‡Šä¹‰ã€‚</div>`;
                html += `</div>`;
            }
            
            panelDictionaryResult.innerHTML = html;
        }
        
        // æ˜¾ç¤º/éšè—å­—å¹•
        toggleSubtitleBtn.addEventListener('click', () => {
            subtitleVisible = !subtitleVisible;
            subtitleDisplay.style.display = subtitleVisible ? 'block' : 'none';
        });
        
        // åˆ‡æ¢è§†é¢‘å†…å­—å¹•æ˜¾ç¤º
        toggleVideoSubtitlesBtn.addEventListener('click', () => {
            videoSubtitlesVisible = !videoSubtitlesVisible;
            if (!videoSubtitlesVisible) {
                videoSubtitles.innerHTML = "";
            } else if (currentSubtitleIndex >= 0) {
                videoSubtitles.innerHTML = `<span>${subtitles[currentSubtitleIndex].text}</span>`;
            }
        });
        
        // ä¸Šä¸€å¥è·³è½¬
        prevSentenceBtn.addEventListener('click', () => {
            if (subtitles.length === 0) return;
            
            let targetIndex = currentSubtitleIndex - 1;
            if (targetIndex < 0) targetIndex = 0;
            
            if (currentMediaType === 'video') {
                videoPlayer.currentTime = subtitles[targetIndex].start;
            } else {
                audioElement.currentTime = subtitles[targetIndex].start;
            }
            currentSubtitleIndex = targetIndex;
            updateActiveSubtitleItem();
        });
        
        // ä¸‹ä¸€å¥è·³è½¬
        nextSentenceBtn.addEventListener('click', () => {
            if (subtitles.length === 0) return;
            
            let targetIndex = currentSubtitleIndex + 1;
            if (targetIndex >= subtitles.length) targetIndex = subtitles.length - 1;
            
            if (currentMediaType === 'video') {
                videoPlayer.currentTime = subtitles[targetIndex].start;
            } else {
                audioElement.currentTime = subtitles[targetIndex].start;
            }
            currentSubtitleIndex = targetIndex;
            updateActiveSubtitleItem();
        });
        
        // æ—¶é—´è·³è½¬
        timeJumpBtn.addEventListener('click', () => {
            const time = parseFloat(timeJumpInput.value);
            if (!isNaN(time) && time >= 0) {
                if (currentMediaType === 'video') {
                    videoPlayer.currentTime = time;
                } else {
                    audioElement.currentTime = time;
                }
            }
        });
        
        timeJumpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const time = parseFloat(timeJumpInput.value);
                if (!isNaN(time) && time >= 0) {
                    if (currentMediaType === 'video') {
                        videoPlayer.currentTime = time;
                    } else {
                        audioElement.currentTime = time;
                    }
                }
            }
        });
        
        // æ˜¾ç¤ºå­—å¹•åˆ—è¡¨
        showSubtitleListBtn.addEventListener('click', () => {
            openSubtitleListPanel();
        });
        
        // æ‰“å¼€å­—å¹•åˆ—è¡¨é¢æ¿
        function openSubtitleListPanel() {
            subtitleListPanel.classList.add('active');
            panelOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // å…³é—­å­—å¹•åˆ—è¡¨é¢æ¿
        function closeSubtitleListPanelFunc() {
            subtitleListPanel.classList.remove('active');
            panelOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        closeSubtitleListPanel.addEventListener('click', closeSubtitleListPanelFunc);
        
        // è¿½åŠ è¯æ±‡åŠŸèƒ½
        appendWordBtn.addEventListener('click', () => {
            const sentenceSpans = originalSentence.querySelectorAll('.sentence-word');
            if (!sentenceSpans.length) return;

            currentWordIndex++;
            if (currentWordIndex >= sentenceSpans.length) currentWordIndex = sentenceSpans.length - 1;

            const currentSpan = sentenceSpans[currentWordIndex];
            const word = currentSpan.getAttribute('data-word');

            appendedWords.push(word);
            panelSearchInput.value = appendedWords.join('');

            // é«˜äº®å·²è¿½åŠ è¯å—
            sentenceSpans.forEach((span, idx) => {
                span.classList.toggle('highlight', idx <= currentWordIndex);
            });

            // è§¦å‘æœç´¢
            if (currentLanguageMode === 'english') {
                searchWordInPanel(panelSearchInput.value);
            } else {
                searchJapaneseWordInPanel(panelSearchInput.value);
            }

            // å¦‚æœå½“å‰æ ‡ç­¾é¡µæ˜¯ç½‘é¡µæŸ¥è¯¢ â†’ è‡ªåŠ¨åŠ è½½ç½‘é¡µ
            if (activeTab === 'web-tab') {
                loadWebSearch(panelSearchInput.value);
            }
        });

        // é‡ç½®è¿½åŠ è¯æ±‡å’Œæœç´¢æ 
        function resetAppendedWords() {
            currentWordIndex = -1;
            appendedWords = [];
            panelSearchInput.value = '';
            
            // æ¸…é™¤åŸå¥é«˜äº®
            originalSentence.querySelectorAll('.sentence-word').forEach(span => {
                span.classList.remove('highlight');
            });
        }

        // Ankiè¿æ¥æ£€æŸ¥
        async function checkAnkiConnection() {
            ankiStatusText.textContent = 'æ£€æŸ¥Ankiè¿æ¥çŠ¶æ€...';
            
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'version',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.result) {
                        ankiConnected = true;
                        ankiStatusIndicator.className = 'status-indicator status-connected';
                        ankiStatusText.textContent = 'Ankiå·²è¿æ¥';
                        
                        // è·å–ç‰Œç»„å’Œæ¨¡å‹ä¿¡æ¯
                        await loadAnkiDecks();
                        await loadAnkiModels();
                    } else {
                        throw new Error('AnkiConnectå“åº”é”™è¯¯');
                    }
                } else {
                    throw new Error('AnkiConnectå“åº”é”™è¯¯');
                }
            } catch (error) {
                ankiConnected = false;
                ankiStatusIndicator.className = 'status-indicator status-disconnected';
                ankiStatusText.textContent = 'Ankiæœªè¿æ¥';
                console.error('Ankiè¿æ¥é”™è¯¯:', error);
            }
        }
        
        // è·å–Ankiç‰Œç»„åˆ—è¡¨
        async function loadAnkiDecks() {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'deckNames',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    ankiDecks = data.result;
                    
                    // æ›´æ–°ç‰Œç»„é€‰æ‹©æ¡†
                    deckSelect.innerHTML = '';
                    ankiDecks.forEach(deck => {
                        const option = document.createElement('option');
                        option.value = deck;
                        option.textContent = deck;
                        deckSelect.appendChild(option);
                    });
                    
                    // åŠ è½½ä¿å­˜çš„é…ç½®
                    loadConfig();
                }
            } catch (error) {
                console.error('è·å–ç‰Œç»„åˆ—è¡¨é”™è¯¯:', error);
            }
        }
        
        // è·å–Ankiæ¨¡å‹åˆ—è¡¨
        async function loadAnkiModels() {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'modelNames',
                        version: 6
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    ankiModels = data.result;
                    
                    // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
                    modelSelect.innerHTML = '';
                    ankiModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    
                    // åŠ è½½ä¿å­˜çš„é…ç½®
                    loadConfig();
                    
                    // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæ¨¡å‹å¹¶åŠ è½½å­—æ®µ
                    if (ankiModels.length > 0 && !modelSelect.value) {
                        modelSelect.value = ankiModels[0];
                        await loadModelFields(ankiModels[0]);
                    } else if (modelSelect.value) {
                        // å¦‚æœå·²æœ‰ä¿å­˜çš„æ¨¡å‹ï¼ŒåŠ è½½å…¶å­—æ®µ
                        await loadModelFields(modelSelect.value);
                    }
                }
            } catch (error) {
                console.error('è·å–æ¨¡å‹åˆ—è¡¨é”™è¯¯:', error);
            }
        }
        
        // è·å–æ¨¡å‹å­—æ®µ
        async function loadModelFields(modelName) {
            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'modelFieldNames',
                        version: 6,
                        params: {
                            modelName: modelName
                        }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentModelFields = data.result;
                    
                    // æ›´æ–°å­—æ®µé€‰æ‹©æ¡†
                    wordFieldSelect.innerHTML = '';
                    sentenceFieldSelect.innerHTML = '';
                    definitionFieldSelect.innerHTML = '';
                    audioFieldSelect.innerHTML = '';
                    imageFieldSelect.innerHTML = '';
                    
                    currentModelFields.forEach(field => {
                        const option = document.createElement('option');
                        option.value = field;
                        option.textContent = field;
                        
                        wordFieldSelect.appendChild(option.cloneNode(true));
                        sentenceFieldSelect.appendChild(option.cloneNode(true));
                        definitionFieldSelect.appendChild(option.cloneNode(true));
                        audioFieldSelect.appendChild(option.cloneNode(true));
                        imageFieldSelect.appendChild(option.cloneNode(true));
                    });
                    
                    // åŠ è½½ä¿å­˜çš„é…ç½®
                    loadConfig();
                    
                    // å¦‚æœå­—æ®µä¸ºç©ºï¼Œå°è¯•æ™ºèƒ½è®¾ç½®é»˜è®¤å­—æ®µ
                    if (!wordFieldSelect.value) {
                        setDefaultFields();
                    }
                }
            } catch (error) {
                console.error('è·å–æ¨¡å‹å­—æ®µé”™è¯¯:', error);
            }
        }
        
        // æ™ºèƒ½è®¾ç½®é»˜è®¤å­—æ®µ
        function setDefaultFields() {
            const fields = currentModelFields.map(f => f.toLowerCase());
            
            // è®¾ç½®å•è¯å­—æ®µ
            if (fields.includes('word')) {
                wordFieldSelect.value = 'word';
            } else if (fields.includes('front')) {
                wordFieldSelect.value = 'front';
            } else if (fields.length > 0) {
                wordFieldSelect.selectedIndex = 0;
            }
            
            // è®¾ç½®å¥å­å­—æ®µ
            if (fields.includes('sentence')) {
                sentenceFieldSelect.value = 'sentence';
            } else if (fields.includes('example')) {
                sentenceFieldSelect.value = 'example';
            } else if (fields.includes('back')) {
                sentenceFieldSelect.value = 'back';
            } else if (fields.length > 1) {
                sentenceFieldSelect.selectedIndex = 1;
            }
            
            // è®¾ç½®é‡Šä¹‰å­—æ®µ
            if (fields.includes('definition')) {
                definitionFieldSelect.value = 'definition';
            } else if (fields.includes('meaning')) {
                definitionFieldSelect.value = 'meaning';
            } else if (fields.includes('back')) {
                definitionFieldSelect.value = 'back';
            } else if (fields.length > 2) {
                definitionFieldSelect.selectedIndex = 2;
            }
            
            // è®¾ç½®éŸ³é¢‘å­—æ®µ
            if (fields.includes('audio')) {
                audioFieldSelect.value = 'audio';
            } else if (fields.includes('sound')) {
                audioFieldSelect.value = 'sound';
            } else if (fields.length > 3) {
                audioFieldSelect.selectedIndex = 3;
            }
            
            // è®¾ç½®å›¾ç‰‡å­—æ®µ
            if (fields.includes('image')) {
                imageFieldSelect.value = 'image';
            } else if (fields.includes('picture')) {
                imageFieldSelect.value = 'picture';
            } else if (fields.length > 4) {
                imageFieldSelect.selectedIndex = 4;
            }
            
            // ä¿å­˜é…ç½®
            saveConfig();
        }
        
        // æ£€æŸ¥Ankiè¿æ¥
        checkAnkiBtn.addEventListener('click', checkAnkiConnection);
        
        // æ˜¾ç¤º/éšè—é…ç½®
        showConfigBtn.addEventListener('click', () => {
            const isHidden = autoConfigSection.classList.contains('hidden');
            if (isHidden) {
                autoConfigSection.classList.remove('hidden');
                showConfigBtn.textContent = 'æ”¶èµ·';
            } else {
                autoConfigSection.classList.add('hidden');
                showConfigBtn.textContent = 'é…ç½®';
            }
        });
        
        // æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶åŠ è½½å­—æ®µ
        modelSelect.addEventListener('change', () => {
            loadModelFields(modelSelect.value);
            saveConfig();
        });
        
        // é…ç½®å˜åŒ–æ—¶ä¿å­˜
        deckSelect.addEventListener('change', saveConfig);
        wordFieldSelect.addEventListener('change', saveConfig);
        sentenceFieldSelect.addEventListener('change', saveConfig);
        definitionFieldSelect.addEventListener('change', saveConfig);
        audioFieldSelect.addEventListener('change', saveConfig);
        imageFieldSelect.addEventListener('change', saveConfig);
        
        // ä¿®å¤ï¼šç®€åŒ–Ankiæ·»åŠ æµç¨‹ï¼Œç§»é™¤å¼‚æ­¥ç­‰å¾…
        addToAnkiBtn.addEventListener('click', () => {
            if (isProcessingAnki) return;
            
            if (!ankiConnected) {
                alert('è¯·å…ˆè¿æ¥Anki!');
                return;
            }
            
            const word = panelSearchInput.value.trim();
            if (!word) {
                alert('è¯·è¾“å…¥è¦æ·»åŠ çš„å•è¯!');
                return;
            }
            
            // è·å–è¯å…¸å†…å®¹
            let definition = '';
            
            // æ ¹æ®å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µè·å–é‡Šä¹‰
            if (activeTab === 'dictionary-tab') {
                // ä»è¯å…¸é‡Šä¹‰æ ‡ç­¾é¡µè·å–å†…å®¹
                const definitionElements = panelDictionaryResult.querySelectorAll('.definition');
                if (definitionElements.length > 0) {
                    definitionElements.forEach(el => {
                        definition += el.textContent + '\n';
                    });
                }
            } else if (activeTab === 'custom-tab') {
                // ä»è‡ªå®šä¹‰é‡Šä¹‰æ ‡ç­¾é¡µè·å–å†…å®¹
                definition = customDefinitionInput.value.trim();
            }
            
            if (!definition) {
                alert('è¯·æä¾›å•è¯é‡Šä¹‰!');
                return;
            }
            
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            isProcessingAnki = true;
            addToAnkiBtn.disabled = true;
            
            // ç«‹å³å…³é—­é¢æ¿å¹¶æ¢å¤æ’­æ”¾
            closeDictionaryPanel();
            
            // ä½¿ç”¨setTimeouté¿å…é˜»å¡UI
            setTimeout(() => {
                processAnkiCard(word, definition)
                    .then(() => {
                        console.log('å¡ç‰‡æ·»åŠ æˆåŠŸ');
                    })
                    .catch(error => {
                        console.error('æ·»åŠ å¡ç‰‡å¤±è´¥:', error);
                        alert('æ·»åŠ å¡ç‰‡å¤±è´¥: ' + error.message);
                    })
                    .finally(() => {
                        // é‡ç½®å¤„ç†çŠ¶æ€
                        isProcessingAnki = false;
                        addToAnkiBtn.disabled = false;
                        
                        // é‡ç½®è¡¨å•
                        customDefinitionInput.value = '';
                        panelSearchInput.value = '';
                        panelDictionaryResult.innerHTML = 'æŸ¥è¯¢ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...';
                    });
            }, 100);
        });
        
        // ä¿®å¤éŸ³é¢‘æˆªå–é—®é¢˜ - ä½¿ç”¨ä¹‹å‰æˆåŠŸçš„ä»£ç 
        async function processAnkiCard(word, definition) {
            console.log('audioBuffer', audioBuffer, 'audioContext', audioContext, 'currentSubtitleIndex', currentSubtitleIndex);

            const note = {
                deckName: deckSelect.value,
                modelName: modelSelect.value,
                fields: {
                    [wordFieldSelect.value]: word,
                    [sentenceFieldSelect.value]: currentSentence,
                    [definitionFieldSelect.value]: definition
                },
                options: { allowDuplicate: false },
                tags: ['media-player']
            };

            // è‡ªåŠ¨æˆªå–å½“å‰å•è¯æ‰€åœ¨å­—å¹•éŸ³é¢‘
            if (audioBuffer && currentSubtitleIndex >= 0) {
                try {
                    const audioBlob = await generateAudioClip(currentSubtitleIndex);
                    if (audioBlob) {
                        const storedAudioName = await processAudioFile(word, audioBlob);
                        if (storedAudioName) {
                            note.fields[audioFieldSelect.value] = `[sound:${storedAudioName}]`;
                            console.log('éŸ³é¢‘å­—æ®µè®¾ç½®:', storedAudioName);
                        }
                    }
                } catch (error) {
                    console.error('éŸ³é¢‘æˆªå–å¤±è´¥:', error);
                }
            }

            // å¤„ç†æˆªå›¾
            if (imageFieldSelect.value && currentMediaType === 'video' && currentMediaFile) {
                try {
                    const storedImageName = await captureVideoFrame(word);
                    if (storedImageName) {
                        note.fields[imageFieldSelect.value] = `<img src="${storedImageName}">`;
                        console.log('å›¾ç‰‡å­—æ®µè®¾ç½®:', storedImageName);
                    }
                } catch (error) {
                    console.error('æˆªå›¾å¤±è´¥:', error);
                }
            }

            // æ·»åŠ åˆ° Anki
            await addCardToAnki(note);
        }

        // ç”Ÿæˆæ–‡ä»¶å
        function generateAudioFileName(word) {
            const cleanWord = word.replace(/[^a-z]/gi, '').toLowerCase() || 'audio';
            // å¢åŠ æ—¶é—´æˆ³é¿å…é‡å
            let fileName = `audio_${cleanWord}_${Date.now()}.wav`;
            fileName = fileName.replace(/[^\w.\-]/g, '_');
            return fileName;
        }
        
        function generateImageFileName(word) {
            const cleanWord = word.replace(/[^a-z]/gi, '').toLowerCase() || 'screenshot';
            // å¢åŠ æ—¶é—´æˆ³é¿å…é‡å
            let fileName = `screenshot_${cleanWord}_${Date.now()}.jpg`;
            fileName = fileName.replace(/[^\w.\-]/g, '_');
            return fileName;
        }

        // è‡ªåŠ¨æˆªå–å½“å‰å­—å¹•çš„éŸ³é¢‘ç‰‡æ®µ
        async function processAudioFile(word, audioBlob) {
            try {
                const audioFileName = generateAudioFileName(word);
                console.log('å‡†å¤‡å­˜å‚¨éŸ³é¢‘æ–‡ä»¶:', audioFileName);

                const base64Audio = await blobToBase64(audioBlob);

                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'storeMediaFile',
                        version: 6,
                        params: {
                            filename: audioFileName,
                            data: base64Audio.split(',')[1],
                            deleteExisting: true
                        }
                    })
                });

                const result = await response.json();
                if (result.error) {
                    console.error('å­˜å‚¨éŸ³é¢‘æ–‡ä»¶å¤±è´¥:', result.error);
                    return null;
                }

                const storedName = result.result || audioFileName;
                console.log('éŸ³é¢‘æ–‡ä»¶å®é™…å­˜å‚¨å:', storedName);
                return storedName;

            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†é”™è¯¯:', error);
                return null;
            }
        }
                
        // æˆªå›¾åŠŸèƒ½
        async function captureVideoFrame(word) {
            return new Promise((resolve, reject) => {
                try {
                    // åˆ›å»ºcanvaså…ƒç´ 
                    const canvas = document.createElement('canvas');
                    const video = document.getElementById('player');
                    
                    // è®¾ç½®canvaså°ºå¯¸ä¸è§†é¢‘ä¸€è‡´
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // ç»˜åˆ¶è§†é¢‘å½“å‰å¸§åˆ°canvas
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // å°†canvasè½¬æ¢ä¸ºBlob
                    canvas.toBlob(async (blob) => {
                        try {
                            const imageFileName = generateImageFileName(word);
                            const base64Image = await blobToBase64(blob);

                            const response = await fetch('http://127.0.0.1:8765', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'storeMediaFile',
                                    version: 6,
                                    params: {
                                        filename: imageFileName,
                                        data: base64Image.split(',')[1],
                                        deleteExisting: true
                                    }
                                })
                            });

                            const result = await response.json();
                            if (result.error) {
                                console.error('å­˜å‚¨å›¾ç‰‡æ–‡ä»¶å¤±è´¥:', result.error);
                                reject(new Error(result.error));
                                return;
                            }

                            // ä½¿ç”¨è¿”å›çš„ result å­—æ®µï¼ˆå®é™…æ–‡ä»¶åï¼‰
                            const storedName = result.result || imageFileName;
                            console.log('å›¾ç‰‡æ–‡ä»¶å®é™…å­˜å‚¨å:', storedName);
                            resolve(storedName);
                        } catch (error) {
                            console.error('å›¾ç‰‡å¤„ç†é”™è¯¯:', error);
                            reject(error);
                        }
                    }, 'image/jpeg', 0.8);
                } catch (error) {
                    console.error('æˆªå›¾é”™è¯¯:', error);
                    reject(error);
                }
            });
        }

        function bufferToWavBlob(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const length = buffer.length * numChannels * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);

            // å†™ WAV å¤´éƒ¨
            let offset = 0;
            function writeString(s) {
                for (let i = 0; i < s.length; i++) view.setUint8(offset++, s.charCodeAt(i));
            }

            function write16(v) { view.setInt16(offset, v, true); offset += 2; }
            function write32(v) { view.setUint32(offset, v, true); offset += 4; }

            writeString('RIFF');
            write32(length - 8);
            writeString('WAVEfmt ');
            write32(16);
            write16(1);
            write16(numChannels);
            write32(sampleRate);
            write32(sampleRate * numChannels * 2);
            write16(numChannels * 2);
            write16(16);
            writeString('data');
            write32(length - 44);

            // å†™éŸ³é¢‘æ•°æ®
            for (let i = 0; i < buffer.length; i++) {
                for (let ch = 0; ch < numChannels; ch++) {
                    let sample = buffer.getChannelData(ch)[i];
                    sample = Math.max(-1, Math.min(1, sample));
                    view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7fff, true);
                    offset += 2;
                }
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // ç”Ÿæˆå½“å‰å¥å­çš„éŸ³é¢‘ç‰‡æ®µ
        async function generateAudioClip(subtitleIndex) {
            if (!audioBuffer) throw new Error('audioBuffer æœªåŠ è½½');

            const startTime = subtitles[subtitleIndex].start; // å•è¯å¯¹åº”å­—å¹•å¼€å§‹æ—¶é—´
            const endTime = subtitles[subtitleIndex].end;     // å•è¯å¯¹åº”å­—å¹•ç»“æŸæ—¶é—´

            const sampleRate = audioBuffer.sampleRate;
            const startSample = Math.floor(startTime * sampleRate);
            const endSample = Math.floor(endTime * sampleRate);
            const frameCount = endSample - startSample;

            const newBuffer = audioContext.createBuffer(
                audioBuffer.numberOfChannels,
                frameCount,
                sampleRate
            );

            for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
                const oldData = audioBuffer.getChannelData(channel);
                const newData = newBuffer.getChannelData(channel);
                for (let i = 0; i < frameCount; i++) {
                    newData[i] = oldData[startSample + i];
                }
            }

            // è½¬ Blob
            return bufferToWavBlob(newBuffer);
        }
                    
        // å°†AudioBufferè½¬æ¢ä¸ºWAV Blob
        function bufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const length = buffer.length;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            
            // è®¡ç®—æ•°æ®å¤§å°
            const dataSize = length * blockAlign;
            
            // åˆ›å»ºWAVæ–‡ä»¶å¤´
            const bufferArray = new ArrayBuffer(44 + dataSize);
            const view = new DataView(bufferArray);
            
            // RIFFæ ‡è¯†
            writeString(view, 0, 'RIFF');
            // æ–‡ä»¶é•¿åº¦
            view.setUint32(4, 36 + dataSize, true);
            // WAVEæ ‡è¯†
            writeString(view, 8, 'WAVE');
            // fmt chunk
            writeString(view, 12, 'fmt ');
            // fmt chunké•¿åº¦
            view.setUint32(16, 16, true);
            // éŸ³é¢‘æ ¼å¼ (1 = PCM)
            view.setUint16(20, 1, true);
            // å£°é“æ•°
            view.setUint16(22, numChannels, true);
            // é‡‡æ ·ç‡
            view.setUint32(24, sampleRate, true);
            // å­—èŠ‚ç‡
            view.setUint32(28, sampleRate * blockAlign, true);
            // å—å¯¹é½
            view.setUint16(32, blockAlign, true);
            // ä½æ·±åº¦
            view.setUint16(34, bytesPerSample * 8, true);
            // data chunk
            writeString(view, 36, 'data');
            // data chunké•¿åº¦
            view.setUint32(40, dataSize, true);
            
            // å†™å…¥PCMæ•°æ®
            const offset = 44;
            let index = 0;
            
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    const int16Sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset + index, int16Sample, true);
                    index += 2;
                }
            }
            
            return new Blob([bufferArray], { type: 'audio/wav' });
        }
                
        // å†™å…¥å­—ç¬¦ä¸²åˆ°DataView
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        async function addCardToAnki(note) {
            console.log('å‡†å¤‡æ·»åŠ å¡ç‰‡åˆ° Anki:', note);

            try {
                const response = await fetch('http://127.0.0.1:8765', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'addNote',
                        version: 6,
                        params: { note }
                    }),
                });

                // æ£€æŸ¥ HTTP å±‚é¢
                if (!response.ok) {
                    throw new Error(`AnkiConnect HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }

                // å°è¯•è§£æè¿”å›ç»“æœ
                let result;
                try {
                    result = await response.json();
                } catch (err) {
                    throw new Error('æ— æ³•è§£æ AnkiConnect è¿”å›çš„ JSONã€‚å¯èƒ½æœªå¯åŠ¨ AnkiConnectã€‚');
                }

                // æ£€æŸ¥ API å±‚é¢é”™è¯¯
                if (result.error) {
                    // å¸¸è§æƒ…å†µï¼šå¡ç‰‡å·²å­˜åœ¨
                    if (result.error.includes('cannot create note because it is a duplicate')) {
                        console.warn('æ£€æµ‹åˆ°é‡å¤å¡ç‰‡ï¼Œæœªæ·»åŠ :', note.fields);
                        showStatusMessage('âš ï¸ å·²å­˜åœ¨ç›¸åŒå¡ç‰‡ï¼Œè·³è¿‡æ·»åŠ ã€‚');
                        return null;
                    } else {
                        console.error('æ·»åŠ å¡ç‰‡å¤±è´¥:', result.error);
                        console.error('å¡ç‰‡æ•°æ®:', note);
                        showStatusMessage('âŒ æ·»åŠ å¡ç‰‡å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ã€‚');
                        throw new Error(result.error);
                    }
                }

                // ç¡®ä¿ result.result å­˜åœ¨
                if (!result.result) {
                    console.warn('AnkiConnect è¿”å›ç©ºç»“æœï¼Œå¯èƒ½æœªåˆ›å»ºå¡ç‰‡ã€‚');
                    showStatusMessage('âš ï¸ æœªåˆ›å»ºå¡ç‰‡ï¼Œå¯èƒ½æ˜¯é‡å¤æˆ–æ¨¡å‹ä¸åŒ¹é…ã€‚');
                    return null;
                }

                console.log('âœ… å¡ç‰‡æ·»åŠ æˆåŠŸï¼ŒID:', result.result);
                showStatusMessage('âœ… å¡ç‰‡å·²æˆåŠŸæ·»åŠ åˆ° Anki!');
                return result.result;

            } catch (error) {
                console.error('âŒ ä¸ AnkiConnect é€šä¿¡å¤±è´¥:', error);
                showStatusMessage('âŒ æ— æ³•è¿æ¥åˆ° AnkiConnectï¼Œè¯·ç¡®è®¤å®ƒå·²è¿è¡Œã€‚');
                return null;
            }
        }

        // ä¸€ä¸ªç®€å•çš„çŠ¶æ€æç¤ºå‡½æ•°ï¼ˆå¯æ›¿æ¢ alertï¼‰
        function showStatusMessage(message) {
            // âœ… åœ¨ç½‘é¡µä¸Šæµ®åŠ¨æç¤ºï¼ˆä¸ä¼šé˜»å¡ï¼‰
            const div = document.createElement('div');
            div.textContent = message;
            div.style.position = 'fixed';
            div.style.bottom = '20px';
            div.style.right = '20px';
            div.style.background = 'rgba(0,0,0,0.8)';
            div.style.color = '#fff';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '6px';
            div.style.fontSize = '14px';
            div.style.zIndex = '9999';
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }
        
        // å°†Blobè½¬æ¢ä¸ºBase64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
                
        // åº•éƒ¨é¢æ¿åŠŸèƒ½
        function openDictionaryPanel() {
            panelDictionaryResult.style.display = 'block'; //æµ‹è¯•
            panelWordTitle.style.display = 'block';  //æµ‹è¯•
            dictionaryPanel.classList.add('active');
            panelOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDictionaryPanel() {
            panelDictionaryResult.style.display = 'none'; //æµ‹è¯•
            panelWordTitle.style.display = 'none'; //æµ‹è¯•
            dictionaryPanel.classList.remove('active');
            panelOverlay.classList.remove('active');
            document.body.style.overflow = '';
            
            // æ¢å¤æ’­æ”¾
            if (playerWasPlaying) {
                if (currentMediaType === 'video' && videoPlayer.paused) {
                    videoPlayer.play();
                } else if (currentMediaType === 'audio' && audioElement.paused) {
                    audioElement.play();
                    audioPlayPauseBtn.textContent = 'â¸';
                    audioPlayPauseBtn.classList.add('active');
                }
            }

            // æ¸…ç©ºæœç´¢æ å’Œè¿½åŠ çŠ¶æ€
            resetAppendedWords();
        }
        
        closePanelBtn.addEventListener('click', closeDictionaryPanel);
        panelOverlay.addEventListener('click', () => {
            closeDictionaryPanel();
            closeSubtitleListPanelFunc();
        });
        
        // é¢æ¿æœç´¢åŠŸèƒ½
        panelSearchBtn.addEventListener('click', () => {
            const word = panelSearchInput.value.trim();
            if (currentLanguageMode === 'english') {
                searchWordInPanel(word);
            } else {
                searchJapaneseWordInPanel(word);
            }
        });
        
        panelSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const word = panelSearchInput.value.trim();
                if (currentLanguageMode === 'english') {
                    searchWordInPanel(word);
                } else {
                    searchJapaneseWordInPanel(word);
                }
            }
        });
        
        // æ–°å¢ï¼šæ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                // æ›´æ–°æ¿€æ´»çš„æ ‡ç­¾é¡µ
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabPanes.forEach(pane => pane.classList.remove('active'));
                
                button.classList.add('active');
                document.getElementById(tabId).classList.add('active');
                
                // æ›´æ–°å½“å‰æ¿€æ´»çš„æ ‡ç­¾é¡µ
                activeTab = tabId;
                
                // å¦‚æœæ˜¯ç½‘é¡µæŸ¥è¯¢æ ‡ç­¾ï¼ŒåŠ è½½é¢„è®¾çš„ç½‘é¡µ
                if (tabId === 'web-tab') {
                    const word = panelSearchInput.value.trim();
                    if (word) {
                        loadWebSearch(word);
                    }
                }
            });
        });
        
        // åŠ è½½ç½‘é¡µæŸ¥è¯¢
        function loadWebSearch(word) {
            if (!word) return;
            
            // æ²¹çŒ´è„šæœ¬æ¥å£ï¼šç½‘é¡µæŸ¥è¯¢å›è°ƒ
            if (window.webSearch) {
                window.webSearch(word);
            } else {
                // é»˜è®¤è¡Œä¸ºï¼šä½¿ç”¨Jishoè¿›è¡Œæ—¥è¯­æŸ¥è¯¢
                const url = currentLanguageMode === 'japanese' ? 
                    `https://jisho.org/search/${encodeURIComponent(word)}` :
                    `https://www.youdao.com/result?word=${encodeURIComponent(word)}&lang=en`;
                webSearchFrame.src = url;
            }
        }
        
        // ç›‘å¬æ’­æ”¾å™¨æ—¶é—´æ›´æ–°
        videoPlayer.addEventListener('timeupdate', event => {
            updateSubtitle(videoPlayer.currentTime);
        });
        
        // åˆå§‹åŒ–
        async function init() {
            // æ£€æŸ¥Ankiè¿æ¥
            checkAnkiConnection();
            
            // åŠ è½½é…ç½®
            loadConfig();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateLanguageModeButton();
            updateMediaModeButton();
            updateControlButtons();
            
            // åˆå§‹åŒ– kuromoji åˆ†è¯å™¨
            // await initKuromoji();
            try {
                await initKuromoji(); // ç¡®ä¿åˆ†è¯å™¨å®ä¾‹å·²ç»ç”Ÿæˆ
                if (!tokenizer) {
                    console.error("åˆ†è¯å™¨æœªåˆå§‹åŒ–");
                    return;
                }

                // æµ‹è¯•åˆ†è¯
                const sentence = "ã™ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã‚‚ã®ã†ã¡";
                const tokens = tokenizer.tokenize(sentence);
                console.log(tokens.map(t => t.surface_form).join(" | "));
            } catch (err) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", err);
            }
        }
        
        // å¯åŠ¨åˆå§‹åŒ–
        init();
        
        // æ²¹çŒ´è„šæœ¬æ¥å£
        window.mediaPlayer = {
            // è®¾ç½®æ—¥è¯­åˆ†è¯ç»“æœ
            setJapaneseSegmentation: (words) => {
                japaneseWords = words;
                currentWordIndex = 0;
            },
            
            // è®¾ç½®æ—¥è¯­æŸ¥è¯¢ç»“æœ
            setJapaneseWordData: (html) => {
                panelDictionaryResult.innerHTML = html;
            },
            
            // è®¾ç½®ç½‘é¡µæŸ¥è¯¢URL
            setWebSearchUrl: (url) => {
                webSearchFrame.src = url;
            },
            
            // è·å–å½“å‰çŠ¶æ€
            getState: () => ({
                currentWord: currentWord,
                currentSentence: currentSentence,
                currentLanguageMode: currentLanguageMode,
                currentMediaType: currentMediaType
            })
        };
    </script>
</body>
</html>